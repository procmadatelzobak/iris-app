{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="/static/css/admin_hlinik_modern.css">
<style>
    /* Inline overrides for specific dynamic elements */
    .view-container {
        padding: 1rem;
        height: calc(100vh - 60px);
        overflow-y: auto;
    }

    /* Monitor Grid */
    .monitor-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }

    .session-card {
        background: rgba(10, 25, 50, 0.9);
        border: 1px solid rgba(79, 168, 255, 0.3);
        border-radius: 8px;
        padding: 10px;
        height: 250px;
        display: flex;
        flex-direction: column;
    }

    /* Controls Layout */
    .canvas-container {
        border: 1px solid rgba(79, 168, 255, 0.4);
        border-radius: 8px;
        height: 100px;
        width: 100%;
        position: relative;
    }

    .btn-action {
        border: 1px solid rgba(100, 180, 255, 0.3);
        border-radius: 4px;
        padding: 2px 8px;
        color: #7fc4ff;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-action:hover {
        border-color: #4fa8ff;
        color: #fff;
        background: rgba(79, 168, 255, 0.2);
    }

    /* Dashboard Grid Layout */
    #hub-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
        max-width: 1200px;
        width: 100%;
        padding: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="crt-overlay"></div>
<div class="flex flex-col h-screen">

    <div id="hub-view" class="h-screen w-screen flex items-center justify-center z-50 absolute inset-0">
        <!-- Hub Docs Buttons -->
        <div class="absolute top-4 right-4 flex gap-4 z-50">
            <a href="/doc/view/admin" target="_blank" class="chernobyl-btn px-3 py-1 text-xs">[
                MANU√ÅL ]</a>
            <a href="/doc/view/system" target="_blank" class="chernobyl-btn px-3 py-1 text-xs">[
                SYSTEM ]</a>
        </div>

        <!-- 2x2 Grid of Dashboard Tiles -->
        <div id="hub-grid">
            <!-- 1. MONITORING -->
            <div class="dashboard-tile h-64 cursor-pointer group" onclick="openStation('monitor')">
                <div class="dashboard-tile-bg"
                    style="background-image: url('/static/img/admin/dashboard_monitor.png');"></div>
                <div class="dashboard-tile-content">
                    <div class="text-6xl font-bold text-white mb-2 group-hover:text-cyan-400 transition"
                        style="font-family: 'Orbitron', sans-serif;">01
                    </div>
                    <h2 class="text-2xl text-cyan-400 font-bold mb-2 group-hover:text-white transition editable-label"
                        data-key="hub_station_1">SLEDOV√ÅN√ç SEZEN√ç</h2>
                    <div class="text-cyan-300/70 editable-label text-sm tracking-widest" data-key="hub_desc_1">
                        MONITORING
                    </div>
                </div>
            </div>

            <!-- 2. CONTROLS -->
            <div class="dashboard-tile h-64 cursor-pointer group" onclick="openStation('controls')">
                <div class="dashboard-tile-bg"
                    style="background-image: url('/static/img/admin/dashboard_controls.png');"></div>
                <div class="dashboard-tile-content">
                    <div class="text-6xl font-bold text-white mb-2 group-hover:text-amber-400 transition"
                        style="font-family: 'Orbitron', sans-serif;">02
                    </div>
                    <h2 class="text-2xl text-amber-400 font-bold mb-2 group-hover:text-white transition editable-label"
                        data-key="hub_station_2">≈ò√çD√çC√ç PANEL</h2>
                    <div class="text-amber-300/70 editable-label text-sm tracking-widest" data-key="hub_desc_2">KONTROLA
                    </div>
                </div>
            </div>

            <!-- 3. ECONOMY -->
            <div class="dashboard-tile h-64 cursor-pointer group" onclick="openStation('economy')">
                <div class="dashboard-tile-bg"
                    style="background-image: url('/static/img/admin/dashboard_economy.png');"></div>
                <div class="dashboard-tile-content">
                    <div class="text-6xl font-bold text-white mb-2 group-hover:text-blue-400 transition"
                        style="font-family: 'Orbitron', sans-serif;">03
                    </div>
                    <h2 class="text-2xl text-blue-400 font-bold mb-2 group-hover:text-white transition editable-label"
                        data-key="hub_station_3">EKONOMICK√ù PANEL</h2>
                    <div class="text-blue-300/70 editable-label text-sm tracking-widest" data-key="hub_desc_3">FINANCE
                    </div>
                </div>
            </div>

            <!-- 4. TASKS -->
            <div class="dashboard-tile h-64 cursor-pointer group" onclick="openStation('tasks')">
                <div class="dashboard-tile-bg" style="background-image: url('/static/img/admin/dashboard_tasks.png');">
                </div>
                <div class="dashboard-tile-content">
                    <div class="text-6xl font-bold text-white mb-2 group-hover:text-purple-400 transition"
                        style="font-family: 'Orbitron', sans-serif;">04
                    </div>
                    <h2 class="text-2xl text-purple-400 font-bold mb-2 group-hover:text-white transition editable-label"
                        data-key="hub_station_4">PANEL S √öKOLY</h2>
                    <div class="text-purple-300/70 editable-label text-sm tracking-widest" data-key="hub_desc_4">AGENDA
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Bar -->
    <div id="station-nav" class="admin-nav z-40 hidden flex justify-between items-center px-4 py-2">
        <div class="text-2xl font-bold text-white flex items-center gap-4">
            <span id="station-title" class="text-shadow px-3 py-1">STANICE</span>
        </div>

        <div class="flex gap-4 ml-auto mr-4">
            <button class="chernobyl-btn px-4 py-1 text-sm font-bold" onclick="closeStation()">
                [ V√ùBƒöR PANELU ]
            </button>

            <div class="w-[1px] bg-gray-600 h-6 mx-2"></div>

            <a href="/doc/view/admin" target="_blank" class="chernobyl-btn px-4 py-1 text-sm">[
                MANU√ÅL ]</a>
            <button class="chernobyl-btn px-4 py-1 text-sm editable-label" data-key="btn_reset_sys"
                onclick="triggerReset()">RESET</button>
            <button class="chernobyl-btn px-4 py-1 text-sm"
                onclick="window.location.href='/auth/logout'">LOGOUT</button>
        </div>
    </div>

    <!-- View A: MONITOR (General, Logs, Graph) -->
    <!-- Force height to fill viewport minus header/padding to ensure graph is large -->
    <div id="view-monitor" class="view-container hidden h-[calc(100vh-100px)] flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2 flex-none bg-black/50 p-2">
            <button class="nav-btn active editable-label" data-key="tab_all" onclick="switchMonitorTab('all')"
                id="mtab-all">V≈†EVIDOUC√ç</button>
            <button class="nav-btn editable-label" data-key="tab_chats" onclick="switchMonitorTab('chats')"
                id="mtab-chats">≈†UM</button>
            <button class="nav-btn editable-label" data-key="tab_logs" onclick="switchMonitorTab('logs')"
                id="mtab-logs">HISTORIE OMYL≈Æ</button>
            <button class="nav-btn editable-label" data-key="tab_graph" onclick="switchMonitorTab('graph')"
                id="mtab-graph">PAVUƒåINA</button>
            <div class="ml-auto text-green-500 font-mono border border-green-900 px-2 bg-black"
                id="monitorShiftDisplay">SHIFT: 0</div>
        </div>

        <!-- Tab Content -->
        <!-- Tab Content -->
        <div id="mon-content-all" class="mon-tab flex-1 min-h-0 flex flex-col">
            <!-- Split View: Grid (Left) + Graph Overview (Right) -->
            <div class="flex gap-4 h-full">
                <div class="w-1/2 flex flex-col">
                    <h3 class="text-green-600 mb-2 editable-label" data-key="hdr_active_sessions">AKTIVN√ç RELACE</h3>
                    <div class="monitor-grid" id="sessionGrid"></div>
                </div>
                <div class="w-1/2 border-l-4 border-gray-800 pl-4 flex flex-col relative">
                    <h3 class="text-green-500 mb-2 w-full text-left editable-label" data-key="tab_graph_mini">
                        VISUALIZACE S√çTƒö (P≈òEHLED)</h3>

                    <!-- Overview graph filling the column -->
                    <div
                        class="relative flex-1 bg-black border border-green-900 shadow-2xl shadow-green-900/20 w-full h-full">
                        <canvas id="networkGraphOverview" class="w-full h-full block"></canvas>

                        <div id="miniLog"
                            class="absolute bottom-0 left-0 right-0 h-32 bg-black/80 border-t border-gray-800 p-2 text-xs font-mono text-gray-500 pointer-events-none overflow-hidden">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="mon-content-chats" class="mon-tab hidden flex-1 min-h-0">
            <!-- Reuse grid logic? admin_ui.js usually populates sessionGrid. We need to duplicate or move? 
                 admin_ui.js populates .monitor-grid class. So just adding another div with that class works.
            -->
            <div class="monitor-grid" id="sessionGridChats"></div>
        </div>

        <div id="mon-content-logs" class="mon-tab hidden flex-1 min-h-0 flex flex-col">
            <div class="flex justify-between mb-2">
                <h3 class="text-gray-400 editable-label" data-key="hdr_log_full">HLIN√çK SYST√âMOV√ù LOG</h3>
                <div class="flex items-center gap-4">
                    <button class="text-xs text-red-500 border border-red-900 px-2 hover:bg-red-900 editable-label"
                        data-key="btn_reset_log" onclick="resetSystemLogs()">VYMAZAT HISTORII</button>
                    <a href="/doc/view/admin" target="_blank"
                        class="border border-yellow-500 text-yellow-500 hover:bg-yellow-900 px-2 py-1 text-xs font-mono transition">[
                        MANU√ÅL ]</a>
                    <a href="/doc/view/system" target="_blank"
                        class="border border-blue-500 text-blue-500 hover:bg-blue-900 px-2 py-1 text-xs font-mono transition">[
                        SYSTEM DOCS ]</a>
                </div>
            </div>
            <div id="fullLog"
                class="flex-1 overflow-y-auto bg-black border border-gray-800 p-4 font-mono text-sm text-green-300">
            </div>
        </div>

        <!-- Relace Tab: Full Screen -->
        <div id="mon-content-graph" class="mon-tab hidden flex-1 min-h-0 flex flex-col">
            <div class="flex-1 min-h-0 bg-black border border-green-900 flex flex-col relative w-full">
                <canvas id="networkGraphFull" class="flex-1 w-full h-full block"></canvas>
            </div>
        </div>
    </div>

    <!-- View B: CONTROLS -->
    <div id="view-controls" class="view-container hidden h-full">
        <div class="tos-container">
            <!-- Left Column: Master Control & Frequency -->
            <div class="flex flex-col gap-6">

                <!-- MASTER CONTROL (Shift) -->
                <div class="tos-module">
                    <div class="tos-header">MASTER CONTROL</div>

                    <div class="tos-screen">
                        <div class="tos-screen-grid"></div>
                        <div class="text-center">
                            <span class="tos-label editable-label" data-key="lbl_shift">CURRENT PHASE</span>
                            <div class="tos-value-display" id="controlShift">0</div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button
                            class="tos-jelly-btn jelly-large jelly-red shadow-lg transform hover:scale-105 transition-transform"
                            onclick="triggerShift()" data-key="btn_shift">
                            ENGAGE NEXT PHASE
                        </button>
                    </div>

                    <div class="tos-jelly-row justify-center mt-6">
                        <div class="tos-jelly-btn jelly-blue"></div>
                        <div class="tos-jelly-btn jelly-white"></div>
                        <div class="tos-jelly-btn jelly-gold"></div>
                        <div class="tos-data-disc"></div>
                    </div>
                </div>

                <!-- SUBSPACE FREQUENCY (Timer) -->
                <div class="tos-module">
                    <div class="tos-header">SUBSPACE FREQ</div>

                    <div class="flex items-center justify-between mb-4">
                        <span class="tos-label editable-label" data-key="lbl_timer">RESPONSE TIMEOUT</span>
                        <div class="font-mono text-xl text-white font-bold" id="timerDisplay">-- s</div>
                    </div>

                    <input type="range" class="tos-slider" min="15" max="300" step="5" id="timerInput"
                        oninput="updateTimerPreview(this.value)">

                    <div class="flex justify-between">
                        <div class="tos-rocker-group">
                            <button class="tos-rocker-btn" onclick="saveResponseTimer()">SET</button>
                            <button class="tos-rocker-btn" onclick="updateTimerPreview(60)">STD</button>
                        </div>
                        <div class="tos-data-disc" style="border-top-color: var(--tos-gold)"></div>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2 font-mono uppercase">Frequency calibration affects agent
                        latency</div>
                </div>

            </div>

            <!-- Right Column: Engineering -->
            <div class="tos-module h-full flex flex-col">
                <div class="tos-header">ENGINEERING</div>

                <!-- Dilithium Power -->
                <div class="mb-8">
                    <div class="flex justify-between items-end mb-2">
                        <span class="tos-label editable-label" data-key="lbl_energy">MATTER/ANTIMATTER</span>
                        <span class="font-mono text-blue-300" id="powerText">-- / -- MW</span>
                    </div>

                    <div class="tos-meter-container">
                        <div id="powerBar" class="tos-meter-bar" style="width: 10%;"></div>
                    </div>

                    <div class="text-right mt-2">
                        <button class="tos-jelly-btn jelly-blue"
                            style="width: 120px; font-size: 0.8rem; font-weight: bold; color: #000;"
                            onclick="buyPower()" id="btnBuyPower">
                            BOOST POWER
                        </button>
                    </div>
                </div>

                <!-- Core Temp -->
                <div class="mb-8">
                    <div class="flex justify-between items-end mb-2">
                        <span class="tos-label editable-label" data-key="lbl_temperature">Tk CORE TEMPERATURE</span>
                        <span class="font-mono text-red-300" id="controlChernobyl">0%</span>
                    </div>

                    <div class="tos-meter-container tos-meter-temp">
                        <div id="chemBar" class="tos-meter-bar" style="width: 0%;"></div>
                    </div>

                    <input type="range" class="tos-slider mt-2" min="20" max="400" id="manualChernobyl"
                        oninput="sendChernobylLevel(this.value)">
                </div>

                <!-- Mode Selectors -->
                <div class="mt-auto">
                    <div class="mb-4">
                        <span class="tos-label editable-label" data-key="lbl_mode">ENGINE MODE</span><br>
                        <div class="tos-rocker-group">
                            <button class="tos-rocker-btn" onclick="setMode('normal')"
                                data-key="btn_mode_normal">IMPULSE</button>
                            <button class="tos-rocker-btn" onclick="setMode('low_power')"
                                data-key="btn_mode_low">AUX</button>
                            <button class="tos-rocker-btn text-red-400" onclick="setMode('overclock')"
                                data-key="btn_mode_oc">WARP</button>
                        </div>
                    </div>

                    <div>
                        <span class="tos-label editable-label" data-key="lbl_vis">VISUAL DATA</span><br>
                        <div class="tos-rocker-group">
                            <button class="tos-rocker-btn" onclick="setHyperVis('normal')"
                                data-key="btn_vis_norm">STD</button>
                            <button class="tos-rocker-btn" onclick="setHyperVis('blackbox')"
                                data-key="btn_vis_bb">RAW</button>
                            <button class="tos-rocker-btn" onclick="setHyperVis('forensic')"
                                data-key="btn_vis_forensic">SCAN</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- View C: ECONOMY -->
    <div id="view-economy" class="view-container hidden">
        <div class="chernobyl-panel p-4 mb-6 bg-black flex justify-between items-center shadow-lg shadow-yellow-900/20">
            <div>
                <h3 class="text-yellow-500 font-bold tracking-widest text-sm mb-1 editable-label"
                    data-key="lbl_treasury">N√ÅRODN√ç BANKA BAHNA</h3>
                <div class="text-4xl text-white font-mono" id="treasuryBalance">---- CR</div>
            </div>
            <div class="text-right font-mono text-sm">
                <div class="text-gray-400">DA≈á: <span class="text-white">10%</span></div>
                <div class="text-gray-400">STAV: <span class="text-green-500">STABILN√ç</span></div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl text-yellow-600 font-bold editable-label" data-key="hdr_eco_sub">EKONOMIKA PODDAN√ùCH</h2>
            <button class="chernobyl-btn border-yellow-500 text-yellow-500 px-4 py-1 editable-label"
                data-key="btn_refresh_eco" onclick="refreshEconomy()">VYKOPAT POKLAD</button>
        </div>
        <table class="eco-table w-full border border-gray-700 bg-gray-900 text-sm">
            <thead>
                <tr class="bg-black text-yellow-500">
                    <th class="border border-gray-700 p-2">ID</th>
                    <th class="border border-gray-700 p-2">U≈ΩIVATEL</th>
                    <th class="border border-gray-700 p-2">KREDITY</th>
                    <th class="border border-gray-700 p-2">STATUS</th>
                    <th class="border border-gray-700 p-2">Z√ÅMEK</th>
                    <th class="border border-gray-700 p-2">AKCE</th>
                </tr>
            </thead>
            <tbody id="economyTableBody">
                <!-- JS -->
            </tbody>
        </table>
    </div>

    <!-- View D: TASKS - LCARS VOYAGER STYLE -->
    <div id="view-tasks" class="view-container hidden">
        <div class="lcars-container">
            <!-- LCARS Top Frame -->
            <div class="lcars-top-frame">
                <div class="lcars-elbow-left"></div>
                <div class="lcars-top-bar">
                    <span class="lcars-title">Spr√°va √ökol≈Ø</span>
                    <div class="lcars-indicator">
                        <span class="lcars-indicator-dot"></span>
                        <span>SYST√âM AKTIVN√ç</span>
                    </div>
                </div>
                <div class="lcars-elbow-right"></div>
            </div>

            <!-- LCARS Main Grid -->
            <div class="lcars-grid">
                <!-- Left Sidebar -->
                <div class="lcars-sidebar"></div>

                <!-- Column 1: Pending -->
                <div class="lcars-column lcars-column-pending">
                    <div class="lcars-header">
                        <div class="lcars-header-cap"></div>
                        <div class="lcars-header-bar">Po≈æadavky na √ökol</div>
                        <div class="lcars-header-end"></div>
                    </div>
                    <div class="lcars-tasks-scroll" id="pendingTasksCtx"></div>
                </div>

                <!-- Column 2: Active -->
                <div class="lcars-column lcars-column-active">
                    <div class="lcars-header">
                        <div class="lcars-header-cap"></div>
                        <div class="lcars-header-bar">Rozpracovan√©</div>
                        <div class="lcars-header-end"></div>
                    </div>
                    <div class="lcars-tasks-scroll" id="activeTasksCtx"></div>
                </div>

                <!-- Column 3: Submitted -->
                <div class="lcars-column lcars-column-submitted">
                    <div class="lcars-header">
                        <div class="lcars-header-cap"></div>
                        <div class="lcars-header-bar">Odevzd√°no</div>
                        <div class="lcars-header-end"></div>
                    </div>
                    <div class="lcars-tasks-scroll" id="submittedTasksCtx"></div>
                </div>

                <!-- Column 4: Paid -->
                <div class="lcars-column lcars-column-paid">
                    <div class="lcars-header">
                        <div class="lcars-header-cap"></div>
                        <div class="lcars-header-bar">Uzav≈ôeno</div>
                        <div class="lcars-header-end"></div>
                    </div>
                    <div class="lcars-tasks-scroll" id="paidTasksCtx"></div>
                </div>
            </div>

            <!-- LCARS Bottom Frame -->
            <div class="lcars-bottom-frame">
                <div class="lcars-bottom-left"></div>
                <div class="lcars-bottom-bar">
                    <div class="lcars-indicator">
                        <span>STARDATE {{ now().strftime('%Y.%j') if now else '2025.351' }}</span>
                    </div>
                </div>
                <div class="lcars-bottom-right"></div>
            </div>
        </div>
    </div>


</div>

<!-- Task Grading Modal - LCARS VOYAGER STYLE -->
<div id="gradingModal" class="hidden fixed inset-0 lcars-modal-overlay z-50 flex items-center justify-center p-4">
    <div class="lcars-modal w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- LCARS Modal Header -->
        <div class="lcars-modal-header">
            <div class="lcars-modal-header-cap"></div>
            <div class="lcars-modal-title">Hodnocen√≠ √ökolu</div>
            <div class="lcars-modal-close" onclick="closeGradingModal()">&times;</div>
        </div>

        <!-- LCARS Modal Body -->
        <div class="lcars-modal-body flex-1 overflow-auto">
            <div class="lcars-modal-grid h-full">
                <!-- Left: Task Prompt -->
                <div class="lcars-modal-section lcars-modal-section-prompt">
                    <div class="lcars-modal-section-header">
                        <span>üìã</span>
                        <span class="lcars-modal-section-title">Zad√°n√≠ √∫kolu</span>
                    </div>
                    <div id="gradeTaskPrompt" class="lcars-modal-section-content">Naƒç√≠t√°m...</div>
                </div>
                <!-- Right: User Submission -->
                <div class="lcars-modal-section lcars-modal-section-response">
                    <div class="lcars-modal-section-header">
                        <span>üìù</span>
                        <span class="lcars-modal-section-title">Odpovƒõƒè u≈æivatele</span>
                    </div>
                    <div id="gradeTaskSubmission" class="lcars-modal-section-content">Naƒç√≠t√°m...</div>
                </div>
            </div>
        </div>

        <!-- LCARS Modal Footer -->
        <div class="lcars-modal-footer">
            <div class="lcars-modal-info">
                <div class="lcars-modal-info-item">
                    U≈æivatel: <span id="gradeUsername" class="lcars-modal-info-value">-</span>
                </div>
                <div class="lcars-modal-info-item lcars-modal-info-reward">
                    Nab√≠zen√° odmƒõna: <span id="gradeReward" class="lcars-modal-info-value">-</span> CR
                </div>
            </div>
            <div class="lcars-grade-buttons">
                <button onclick="gradeTask(0.0)" class="lcars-grade-btn lcars-grade-reject">
                    ‚õî Zam√≠tnout (0%)
                </button>
                <button onclick="gradeTask(0.5)" class="lcars-grade-btn lcars-grade-partial">
                    ‚ö†Ô∏è ƒå√°steƒçn√© (50%)
                </button>
                <button onclick="gradeTask(1.0)" class="lcars-grade-btn lcars-grade-approve">
                    ‚úÖ Schv√°lit (100%)
                </button>
                <button onclick="gradeTask(2.0)" class="lcars-grade-btn lcars-grade-bonus">
                    üåü Bonus (200%)
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Inject backend translations for JS usage
    window.TRANS = {{ translations | tojson | safe }};
</script>
<script src="/static/js/socket_client.js?v=30.5"></script>
<script src="/static/js/admin_ui.js?v=30.5"></script>
{% endblock %}