{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="/static/css/admin_chernobyl.css">
<style>
    .nav-btn {
        padding: 1rem 2rem;
        color: #880;
        border-right: 1px solid #330;
        cursor: pointer;
        font-weight: bold;
    }

    .nav-btn:hover {
        background: #220;
        color: #ff0;
    }

    .nav-btn.active {
        background: #330;
        color: #ff0;
        border-bottom: 3px solid #f00;
    }

    .view-container {
        padding: 1rem;
        height: calc(100vh - 60px);
        overflow-y: auto;
    }

    /* Monitor Grid */
    .monitor-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }

    .session-card {
        background: rgba(0, 10, 0, 0.9);
        border: 1px solid #330000;
        padding: 10px;
        height: 250px;
        /* Fixed height for consistency */
        display: flex;
        flex-direction: column;
    }

    /* Controls Layout */
    .canvas-container {
        border: 1px solid #330;
        height: 100px;
        width: 100%;
        position: relative;
    }

    /* Economy Table */
    .eco-table {
        width: 100%;
        border-collapse: collapse;
    }

    .eco-table th,
    .eco-table td {
        border: 1px solid #330;
        padding: 0.5rem;
        text-align: left;
    }

    .eco-table th {
        color: #f00;
    }

    .btn-action {
        border: 1px solid #555;
        padding: 2px 8px;
        color: #aaa;
        cursor: pointer;
    }

    .btn-action:hover {
        border-color: #fff;
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="crt-overlay"></div>
<div class="flex flex-col h-screen">

    <div id="hub-view"
        class="h-screen w-screen bg-black flex items-center justify-center gap-8 p-10 z-50 absolute inset-0 text-center">
        <!-- Hub Docs Buttons -->
        <div class="absolute top-4 right-4 flex gap-4">
            <a href="/doc/view/admin" target="_blank"
                class="border border-yellow-500 text-yellow-500 hover:bg-yellow-900 px-3 py-1 text-xs font-mono transition">[
                MANU√ÅL ]</a>
            <a href="/doc/view/system" target="_blank"
                class="border border-blue-500 text-blue-500 hover:bg-blue-900 px-3 py-1 text-xs font-mono transition">[
                SYSTEM ]</a>
        </div>
        <div class="chernobyl-panel hover:bg-green-900/20 p-8 flex flex-col items-center justify-center cursor-pointer transition w-64 h-96 group"
            onclick="openStation('monitor')">
            <h2 class="text-6xl text-green-500 font-bold mb-4 font-mono group-hover:text-white transition editable-label"
                data-key="hub_station_1">MONITORING</h2>
            <div class="text-green-300 editable-label" data-key="hub_desc_1">DOHLED</div>
            <div class="mt-auto text-xs text-green-800"><span class="bulb on-green animate-pulse"></span> ONLINE</div>
        </div>
        <div class="chernobyl-panel hover:bg-yellow-900/20 p-8 flex flex-col items-center justify-center cursor-pointer transition w-64 h-96 group"
            onclick="openStation('controls')">
            <h2 class="text-6xl text-yellow-500 font-bold mb-4 font-mono group-hover:text-white transition editable-label"
                data-key="hub_station_2">OVL√ÅD√ÅN√ç</h2>
            <div class="text-yellow-300 editable-label" data-key="hub_desc_2">KONTROLA</div>
            <div class="mt-auto text-xs text-yellow-800"><span class="bulb on-amber"></span> ACTIVE</div>
        </div>
        <div class="chernobyl-panel hover:bg-blue-900/20 p-8 flex flex-col items-center justify-center cursor-pointer transition w-64 h-96 group"
            onclick="openStation('economy')">
            <h2 class="text-6xl text-blue-500 font-bold mb-4 font-mono group-hover:text-white transition editable-label"
                data-key="hub_station_3">EKONOMIKA</h2>
            <div class="text-blue-300 editable-label" data-key="hub_desc_3">FINANCE</div>
            <div class="mt-auto text-xs text-blue-800"><span class="bulb on-green"></span> STABLE</div>
        </div>
        <div class="chernobyl-panel hover:bg-purple-900/20 p-8 flex flex-col items-center justify-center cursor-pointer transition w-64 h-96 group"
            onclick="openStation('tasks')">
            <h2 class="text-6xl text-purple-500 font-bold mb-4 font-mono group-hover:text-white transition editable-label"
                data-key="hub_station_4">√öKOLY</h2>
            <div class="text-purple-300 editable-label" data-key="hub_desc_4">AGENDA</div>
            <div class="mt-auto text-xs text-purple-800"><span class="bulb on-amber animate-pulse"></span> PENDING</div>
        </div>
    </div>

    <!-- Top Bar -->
    <div id="station-nav"
        class="admin-nav z-40 hidden flex justify-between items-center px-4 py-2 border-b-4 border-gray-700 bg-gray-900 shadow-xl">
        <div class="text-2xl font-bold text-white flex items-center gap-4">
            <span id="station-title" class="text-shadow bg-black px-2 border border-gray-600">STANICE</span>
        </div>

        <div class="flex gap-4 ml-auto mr-4">
            <a href="/doc/view/admin" target="_blank"
                class="chernobyl-btn px-4 py-1 text-sm text-yellow-500 border-yellow-800 hover:text-white flex items-center justify-center">[
                MANU√ÅL ]</a>
            <a href="/doc/view/system" target="_blank"
                class="chernobyl-btn px-4 py-1 text-sm text-blue-500 border-blue-800 hover:text-white flex items-center justify-center">[
                SYSTEM ]</a>
            <button class="chernobyl-btn px-4 py-1 text-sm" data-key="btn_labels" onclick="toggleEditMode()">UPRAVIT
                POPISKY</button>
            <button class="chernobyl-btn px-4 py-1 text-sm text-red-500 border-red-800 editable-label"
                data-key="btn_reset_sys" onclick="triggerReset()">RESET SYST√âMU</button>
            <button class="chernobyl-btn px-4 py-1 text-sm text-yellow-500 border-yellow-800"
                onclick="window.location.href='/auth/logout'">ODHL√ÅSIT</button>
        </div>

        <button class="chernobyl-btn px-4 py-1 text-red-400 hover:text-white" onclick="closeStation()">
            [ X ]
        </button>
    </div>

    <!-- View A: MONITOR (Station 1) -->
    <div id="view-monitor" class="view-container hidden pt-4">
        <!-- Monitor Tabs -->
        <div class="flex gap-4 mb-4 border-b-4 border-gray-800 pb-2 bg-black/50 p-2">
            <button class="nav-btn active editable-label" data-key="tab_all" onclick="switchMonitorTab('all')"
                id="mtab-all">V≈†EVIDOUC√ç</button>
            <button class="nav-btn editable-label" data-key="tab_chats" onclick="switchMonitorTab('chats')"
                id="mtab-chats">≈†UM</button>
            <button class="nav-btn editable-label" data-key="tab_logs" onclick="switchMonitorTab('logs')"
                id="mtab-logs">HISTORIE OMYL≈Æ</button>
            <button class="nav-btn editable-label" data-key="tab_graph" onclick="switchMonitorTab('graph')"
                id="mtab-graph">PAVUƒåINA</button>
            <div class="ml-auto text-green-500 font-mono border border-green-900 px-2 bg-black"
                id="monitorShiftDisplay">SHIFT: 0</div>
        </div>

        <!-- Tab Content -->
        <div id="mon-content-all" class="mon-tab">
            <!-- Chats + Logs -->
            <div class="flex gap-4 h-full">
                <div class="w-3/4 flex flex-col">
                    <h3 class="text-green-600 mb-2 editable-label" data-key="hdr_active_sessions">AKTIVN√ç RELACE</h3>
                    <div class="monitor-grid" id="sessionGrid"></div>
                </div>
                <div class="w-1/4 border-l-4 border-gray-800 pl-4 flex flex-col">
                    <h3 class="text-gray-500 mb-2 editable-label" data-key="hdr_log_mini">HLIN√çK LOG</h3>
                    <div id="miniLog"
                        class="flex-1 overflow-y-auto text-xs font-mono text-gray-400 space-y-1 bg-black p-2 border border-gray-800">
                    </div>
                </div>
            </div>
        </div>

        <div id="mon-content-chats" class="mon-tab hidden">
            <div class="monitor-grid" id="sessionGridOnly"></div>
        </div>

        <div id="mon-content-logs" class="mon-tab hidden flex flex-col h-full">
            <div class="flex justify-between mb-2">
                <h3 class="text-gray-400 editable-label" data-key="hdr_log_full">HLIN√çK SYST√âMOV√ù LOG</h3>
                <div class="flex items-center gap-4">
                    <button class="text-xs text-red-500 border border-red-900 px-2 hover:bg-red-900 editable-label"
                        data-key="btn_reset_log" onclick="resetSystemLogs()">VYMAZAT HISTORII</button>
                    <a href="/doc/view/admin" target="_blank"
                        class="border border-yellow-500 text-yellow-500 hover:bg-yellow-900 px-2 py-1 text-xs font-mono transition">[
                        MANU√ÅL ]</a>
                    <a href="/doc/view/system" target="_blank"
                        class="border border-blue-500 text-blue-500 hover:bg-blue-900 px-2 py-1 text-xs font-mono transition">[
                        SYSTEM DOCS ]</a>
                </div>
            </div>
            <div id="fullLog"
                class="flex-1 overflow-y-auto bg-black border border-gray-800 p-4 font-mono text-sm text-green-300">
            </div>
        </div>

        <div id="mon-content-graph" class="mon-tab hidden">
            <canvas id="networkGraph" class="w-full h-full bg-black border border-green-900"></canvas>
        </div>
    </div>

    <!-- View B: CONTROLS -->
    <div id="view-controls" class="view-container hidden">
        <div class="grid grid-cols-2 gap-8">
            <!-- Global Shift -->
            <div class="chernobyl-panel p-6 bg-black">
                <h3 class="text-4xl text-yellow-500 mb-6 editable-label" data-key="lbl_shift">POSUN RELACE</h3>
                <div class="text-8xl font-bold text-white mb-6 text-center border-2 border-yellow-900 p-4"
                    id="controlShift">0</div>
                <button class="w-full chernobyl-btn py-4 hover:bg-yellow-900 editable-label text-xl"
                    data-key="btn_shift" onclick="triggerShift()">
                    [ >> DAL≈†√ç F√ÅZE >> ]
                </button>
            </div>

            <!-- Agent Response Timer -->
            <div class="chernobyl-panel p-6 bg-black">
                <h3 class="text-2xl text-green-400 mb-4 editable-label" data-key="lbl_timer">ƒåAS NA ODPOVƒöƒé AGENTA</h3>
                <div class="text-6xl font-bold text-white mb-4 text-center border border-green-900 p-3"
                    id="timerDisplay">-- s</div>
                <input type="range" class="w-full accent-green-500 bg-gray-800" min="15" max="300" step="5"
                    id="timerInput" oninput="updateTimerPreview(this.value)">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>15s</span>
                    <span>300s</span>
                </div>
                <button
                    class="w-full chernobyl-btn py-2 mt-4 border-green-900 text-green-400 hover:bg-green-900 transition"
                    onclick="saveResponseTimer()">[ ULO≈ΩIT LIMIT ]</button>
                <div class="text-[10px] text-gray-500 mt-2">√öprava se projev√≠ okam≈æitƒõ na agentovi i u≈æivateli.</div>
            </div>

            <!-- Power & Instability Column -->
            <div class="space-y-6">
                <!-- Power Management v1.4 -->
                <div class="chernobyl-panel p-6 bg-black">
                    <h3 class="text-2xl text-blue-500 mb-4 editable-label" data-key="lbl_energy">Z√ÅTƒö≈Ω SERVERU</h3>
                    <div
                        class="bg-gray-900 border border-blue-900 p-1 mb-4 relative overflow-hidden h-12 chernobyl-inset">
                        <div id="powerBar" class="h-full bg-blue-600 transition-all duration-500 relative"
                            style="width: 10%;">
                            <!-- Stripe Pattern -->
                            <div class="absolute inset-0"
                                style="background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.3) 10px, rgba(0,0,0,0.3) 20px);">
                            </div>
                        </div>
                        <div
                            class="absolute inset-0 flex items-center justify-center text-white text-shadow font-bold z-10 text-xl">
                            <span id="powerText">-- / -- MW</span>
                        </div>
                    </div>
                    <button class="w-full chernobyl-btn py-2 hover:bg-blue-900 transition editable-label"
                        data-key="btn_buy_power" onclick="buyPower()" id="btnBuyPower">
                        [ <span id="buyPowerText">NAV√ù≈†IT KAPACITU (+50MW) - 1000 CR</span> ]
                    </button>
                </div>

                <!-- Instability -->
                <div class="chernobyl-panel p-6 bg-black">
                    <h3 class="text-2xl text-red-500 mb-6 editable-label" data-key="lbl_temperature">TEPLOTA SYST√âMU
                    </h3>
                    <div
                        class="bg-gray-900 border border-red-900 p-1 mb-4 relative overflow-hidden h-12 chernobyl-inset">
                        <!-- Background Grid -->
                        <div class="absolute inset-0 opacity-20"
                            style="background-image: linear-gradient(90deg, transparent 50%, #300 50%); background-size: 20px 100%;">
                        </div>

                        <!-- The Bar -->
                        <div id="chemBar" class="h-full transition-all duration-1000 ease-out relative"
                            style="width: 0%; background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);">
                            <div class="absolute right-0 top-0 bottom-0 w-2 bg-white opacity-50 animate-pulse"></div>
                        </div>

                        <!-- Overlay Text -->
                        <div
                            class="absolute inset-0 flex items-center justify-center font-bold text-shadow text-white z-10 text-xl">
                            <span id="controlChernobyl">0%</span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <span class="text-gray-500 block mb-2 editable-label" data-key="lbl_mode">RE≈ΩIM V√ùKONU</span>
                        <div class="flex gap-2">
                            <button
                                class="flex-1 chernobyl-btn p-2 text-sm text-gray-400 hover:text-white transition editable-label"
                                data-key="btn_mode_normal" onclick="setMode('normal')">NORM√ÅL</button>
                            <button
                                class="flex-1 chernobyl-btn p-2 text-sm text-gray-400 hover:text-white transition editable-label"
                                data-key="btn_mode_low" onclick="setMode('low_power')"> √öSPORA</button>
                            <button
                                class="flex-1 chernobyl-btn p-2 text-sm text-red-500 hover:bg-red-900 transition editable-label"
                                data-key="btn_mode_oc" onclick="setMode('overclock')">P≈òET√ç≈ΩEN√ç</button>
                        </div>
                    </div>

                    <div class="mb-6 border-t border-gray-800 pt-4">
                        <span class="text-gray-500 block mb-2 editable-label" data-key="lbl_vis">FILTR PRAVDY</span>
                        <div class="flex gap-2">
                            <button
                                class="flex-1 chernobyl-btn p-2 text-sm text-blue-400 hover:text-white transition width-auto editable-label"
                                data-key="btn_vis_norm" onclick="setHyperVis('normal')">≈Ω√ÅDN√ù</button>
                            <button
                                class="flex-1 chernobyl-btn p-2 text-sm text-gray-400 hover:bg-gray-900 transition width-auto editable-label"
                                data-key="btn_vis_bb" onclick="setHyperVis('blackbox')">ƒåERN√Å SK≈ò√ç≈áKA</button>
                            <button
                                class="flex-1 chernobyl-btn p-2 text-sm text-purple-400 hover:bg-purple-900 transition width-auto editable-label"
                                data-key="btn_vis_forensic" onclick="setHyperVis('forensic')">FOREZKA</button>
                        </div>
                    </div>

                    <input type="range" class="w-full accent-red-600 bg-gray-800" min="20" max="400"
                        id="manualChernobyl" oninput="sendChernobylLevel(this.value)">
                    <div class="text-xs text-gray-600 mt-1">MANU√ÅLN√ç KOREKCE</div>
                </div>
            </div>
        </div>
    </div>

    <!-- View C: ECONOMY -->
    <div id="view-economy" class="view-container hidden">
        <div class="chernobyl-panel p-4 mb-6 bg-black flex justify-between items-center shadow-lg shadow-yellow-900/20">
            <div>
                <h3 class="text-yellow-500 font-bold tracking-widest text-sm mb-1 editable-label"
                    data-key="lbl_treasury">N√ÅRODN√ç BANKA BAHNA</h3>
                <div class="text-4xl text-white font-mono" id="treasuryBalance">---- CR</div>
            </div>
            <div class="text-right font-mono text-sm">
                <div class="text-gray-400">DA≈á: <span class="text-white">10%</span></div>
                <div class="text-gray-400">STAV: <span class="text-green-500">STABILN√ç</span></div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl text-yellow-600 font-bold editable-label" data-key="hdr_eco_sub">EKONOMIKA PODDAN√ùCH</h2>
            <button class="chernobyl-btn border-yellow-500 text-yellow-500 px-4 py-1 editable-label"
                data-key="btn_refresh_eco" onclick="refreshEconomy()">VYKOPAT POKLAD</button>
        </div>
        <table class="eco-table w-full border border-gray-700 bg-gray-900 text-sm">
            <thead>
                <tr class="bg-black text-yellow-500">
                    <th class="border border-gray-700 p-2">ID</th>
                    <th class="border border-gray-700 p-2">U≈ΩIVATEL</th>
                    <th class="border border-gray-700 p-2">KREDITY</th>
                    <th class="border border-gray-700 p-2">STATUS</th>
                    <th class="border border-gray-700 p-2">Z√ÅMEK</th>
                    <th class="border border-gray-700 p-2">AKCE</th>
                </tr>
            </thead>
            <tbody id="economyTableBody">
                <!-- JS -->
            </tbody>
        </table>
    </div>

    <!-- View D: TASKS -->
    <div id="view-tasks" class="view-container hidden">
        <div class="grid grid-cols-2 gap-4 h-full">
            <div class="space-y-4">
                <div class="chernobyl-panel border-blue-900 p-4 flex flex-col bg-black">
                    <h3 class="text-blue-400 font-bold mb-2">PO≈ΩADAVKY NA √öKOL</h3>
                    <div class="flex-1 overflow-y-auto space-y-2" id="pendingTasksCtx"></div>
                </div>
                <div class="chernobyl-panel border-yellow-900 p-4 flex flex-col bg-black">
                    <h3 class="text-yellow-400 font-bold mb-2">ROZPRACOVAN√â</h3>
                    <div class="flex-1 overflow-y-auto space-y-2" id="activeTasksCtx"></div>
                </div>
            </div>
            <div class="space-y-4">
                <div class="chernobyl-panel border-green-900 p-4 flex flex-col bg-black">
                    <h3 class="text-green-400 font-bold mb-2">ODEVZD√ÅNO KE ZHODNOCEN√ç</h3>
                    <div class="flex-1 overflow-y-auto space-y-2" id="submittedTasksCtx"></div>
                </div>
                <div class="chernobyl-panel border-gray-800 p-4 flex flex-col bg-black">
                    <h3 class="text-gray-300 font-bold mb-2">UZAV≈òENO / ZAPLACENO</h3>
                    <div class="flex-1 overflow-y-auto space-y-2" id="paidTasksCtx"></div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- Task Grading Modal -->
<div id="gradingModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
    <div
        class="bg-gray-900 border border-yellow-600 rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-gray-700">
            <h2 class="text-xl font-bold text-yellow-500">HODNOCEN√ç √öKOLU</h2>
            <button onclick="closeGradingModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="flex-1 overflow-auto p-4">
            <div class="grid grid-cols-2 gap-4 h-full">
                <!-- Left: Task Prompt -->
                <div class="bg-black border border-gray-700 rounded p-4 overflow-auto">
                    <h3 class="text-sm text-gray-400 mb-2 uppercase tracking-wider">üìã Zad√°n√≠ √∫kolu</h3>
                    <div id="gradeTaskPrompt" class="text-white font-mono text-sm whitespace-pre-wrap">Naƒç√≠t√°m...</div>
                </div>
                <!-- Right: User Submission -->
                <div class="bg-black border border-green-900 rounded p-4 overflow-auto">
                    <h3 class="text-sm text-green-400 mb-2 uppercase tracking-wider">üìù Odpovƒõƒè u≈æivatele</h3>
                    <div id="gradeTaskSubmission" class="text-white font-mono text-sm whitespace-pre-wrap">Naƒç√≠t√°m...
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 border-t border-gray-700 bg-gray-800">
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-400">U≈æivatel: <span id="gradeUsername"
                        class="text-white font-bold">-</span></span>
                <span class="text-gray-400">Nab√≠zen√° odmƒõna: <span id="gradeReward"
                        class="text-yellow-400 font-bold">-</span> CR</span>
            </div>
            <div class="grid grid-cols-4 gap-3">
                <button onclick="gradeTask(0.0)"
                    class="py-3 rounded font-bold text-lg bg-red-900 hover:bg-red-800 text-red-300 border border-red-600">
                    ‚õî ZAM√çTNOUT (0%)
                </button>
                <button onclick="gradeTask(0.5)"
                    class="py-3 rounded font-bold text-lg bg-yellow-900 hover:bg-yellow-800 text-yellow-300 border border-yellow-600">
                    ‚ö†Ô∏è ƒå√ÅSTEƒåN√â (50%)
                </button>
                <button onclick="gradeTask(1.0)"
                    class="py-3 rounded font-bold text-lg bg-green-900 hover:bg-green-800 text-green-300 border border-green-600">
                    ‚úÖ SCHV√ÅLIT (100%)
                </button>
                <button onclick="gradeTask(2.0)"
                    class="py-3 rounded font-bold text-lg bg-purple-900 hover:bg-purple-800 text-purple-300 border border-purple-600">
                    üåü BONUS (200%)
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Inject backend translations for JS usage
    window.TRANS = {{ translations | tojson | safe }};
</script>
<script src="/static/js/socket_client.js?v=30.5"></script>
<script src="/static/js/admin_ui.js?v=30.5"></script>
{% endblock %}