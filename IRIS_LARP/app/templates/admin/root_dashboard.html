{% extends "base.html" %}

{% block head %}
<style>
    /* Global Overrides for Root */
    body {
        font-family: 'Courier New', monospace;
        background-color: #050505;
        color: #d4af37;
        /* Gold */
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #111;
    }

    ::-webkit-scrollbar-thumb {
        background: #d4af37;
    }

    /* Nav */
    .admin-nav {
        display: flex;
        border-bottom: 2px solid #d4af37;
        background: #111;
        padding-left: 1rem;
    }

    .nav-btn {
        padding: 1rem 2rem;
        color: #886;
        border-right: 1px solid #443;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
    }

    .nav-btn:hover {
        background: #221;
        color: #fff;
        text-shadow: 0 0 5px #d4af37;
    }

    .nav-btn.active {
        background: #332;
        color: #d4af37;
        border-bottom: 3px solid #d4af37;
    }

    .view-container {
        padding: 1rem;
        height: calc(100vh - 60px);
        overflow-y: auto;
    }

    /* God Mode Elements */
    .god-panel {
        border: 1px solid #d4af37;
        padding: 1rem;
        margin-bottom: 1rem;
        background: rgba(20, 20, 10, 0.9);
        box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
    }

    .god-title {
        color: #d4af37;
        font-size: 1.5rem;
        font-weight: bold;
        border-bottom: 1px solid #554;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .btn-god {
        border: 1px solid #d4af37;
        color: #d4af37;
        padding: 0.5rem 1rem;
        text-transform: uppercase;
        background: transparent;
        transition: all 0.2s;
        font-weight: bold;
    }

    .btn-god:hover {
        background: #d4af37;
        color: #000;
        box-shadow: 0 0 15px #d4af37;
    }

    .btn-nuke {
        border-color: #f00;
        color: #f00;
    }

    .btn-nuke:hover {
        background: #f00;
        color: #fff;
        box-shadow: 0 0 20px #f00;
    }

    /* Monitor */
    .session-card {
        border: 1px solid #443;
        background: #0a0a0a;
    }

    .lore-embed {
        border: 1px solid #d4af37;
        background: #0a0a0a;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.12);
        height: 80vh;
    }

    .lore-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: #050505;
    }
</style>
{% endblock %}

{% block content %}
<div class="crt-overlay" style="opacity: 0.05;"></div>
<div class="scan-line" style="opacity: 0.05;"></div>

<div class="flex flex-col h-screen">

    <!-- Navigation -->
    <div class="admin-nav z-10 flex justify-between items-center">
        <div class="flex">
            <div class="nav-btn active" onclick="switchView('dashboard')" id="nav-dashboard">DASHBOARD</div>
            <div class="nav-btn" onclick="switchView('config')" id="nav-config">CONFIG</div>
            <div class="nav-btn" onclick="switchView('economy')" id="nav-economy">GLOBAL ECO</div>
            <div class="nav-btn" onclick="switchView('time')" id="nav-time">CHRONOS</div>
            <div class="nav-btn" onclick="switchView('surveillance')" id="nav-surveillance">PANOPTICON</div>
            <div class="nav-btn" onclick="switchView('simulation')" id="nav-simulation">SIMULATION</div>
            <div class="nav-btn" onclick="switchView('lore')" id="nav-lore">LORE</div>
        </div>
        <div class="flex items-center gap-4">
            <div
                class="px-4 font-mono text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-yellow-600 animate-pulse">
                ROOT ACCESS GRANTED
            </div>
            <a href="/organizer-wiki/" target="_blank"
                class="border border-green-500 text-green-500 hover:bg-green-900 px-2 py-1 text-xs font-mono transition font-bold">[
                WIKI / AUDIT ]</a>
            <a href="/doc/view/root" target="_blank"
                class="border border-yellow-500 text-yellow-500 hover:bg-yellow-900 px-2 py-1 text-xs font-mono transition">[
                MANU√ÅL ]</a>
            <a href="/doc/view/system" target="_blank"
                class="border border-blue-500 text-blue-500 hover:bg-blue-900 px-2 py-1 text-xs font-mono transition">[
                SYSTEM DOCS ]</a>
            <a href="/auth/logout"
                class="border border-red-500 text-red-500 hover:bg-red-900 px-3 py-1 text-sm font-mono transition">
                [ ODHL√ÅSIT ]
            </a>
        </div>
    </div>

    <!-- VIEW: DASHBOARD (Summary) -->
    <div id="view-dashboard" class="view-container">
        <div class="grid grid-cols-3 gap-6">
            <!-- Stats -->
            <div class="god-panel">
                <div class="god-title">SYSTEM STATUS</div>
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span>SHIFT OFFSET</span>
                        <span class="font-mono text-2xl text-white" id="valShift">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ONLINE USERS</span>
                        <span class="font-mono text-2xl text-white" id="valOnline">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span>CHERNOBYL</span>
                        <span class="font-mono text-2xl text-red-500" id="valChernobyl">0%</span>
                    </div>
                </div>
            </div>

            <!-- System Constants Tuning -->
            <div class="god-panel">
                <div class="god-title">PHYSICS CONSTANTS</div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500">TAX RATE (0.0 - 1.0)</label>
                        <input type="number" step="0.01" id="inTax"
                            class="w-full bg-black border border-gray-700 p-1 text-white">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">POWER CALC (MW)</label>
                        <input type="number" id="inPower" class="w-full bg-black border border-gray-700 p-1 text-white">
                    </div>
                    <button class="btn-god w-full mt-2" onclick="applySystemConstants()">[ APPLY PHYSICS ]</button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="god-panel col-span-2">
                <div class="god-title">EXECUTIVE PROTOCOLS</div>
                <div class="grid grid-cols-4 gap-4">
                    <button class="btn-god" onclick="triggerShift()">>> FORCE SHIFT >></button>
                    <button class="btn-god border-pink-500 text-pink-500 hover:bg-pink-900"
                        onclick="broadcastMsg()">GLOBAL BROADCAST</button>
                    <button class="btn-god btn-nuke" onclick="triggerReset()">[ SYSTEM RESET ]</button>
                    <button class="btn-god border-blue-500 text-blue-500 hover:bg-blue-900"
                        onclick="location.reload()">RELOAD UI</button>
                    <button class="btn-god border-yellow-500 text-yellow-500 hover:bg-yellow-900"
                        onclick="restartServer()">[ RESTART SERVER ]</button>
                    <button class="btn-god border-red-600 text-red-600 hover:bg-red-900 animate-pulse"
                        onclick="factoryReset()">[ FACTORY RESET ]</button>
                    <a href="/organizer-wiki/" target="_blank"
                        class="btn-god border-green-500 text-green-500 hover:bg-green-900 text-center flex items-center justify-center font-bold"
                        style="text-decoration:none;">
                        [ OPEN WIKI ]
                    </a>
                    <button class="btn-god border-red-600 text-red-600 hover:bg-black animate-pulse" id="btnPanic"
                        onclick="togglePanic()">
                        ‚ö†Ô∏è PANIC MODE ‚ö†Ô∏è
                    </button>
                </div>
            </div>

            <!-- Raw Logs -->
            <div class="god-panel mt-6 max-h-80 overflow-hidden">
                <div class="god-title">SYSTEM LOG STREAM</div>
                <div id="logStream"
                    class="font-mono text-xs text-gray-400 h-64 overflow-y-auto p-2 bg-black border border-gray-800">
                    <!-- Logs from socket -->
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: CONFIG -->
    <div id="view-config" class="view-container hidden">
        <!-- Test Mode Panel -->
        <div class="god-panel">
            <div class="god-title">üîß DEVELOPER MODE</div>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-lg font-bold">Quick Login Buttons</div>
                        <div class="text-sm text-gray-500">Enable passwordless login for testing (shows user buttons
                            on
                            login screen)</div>
                    </div>
                    <button id="btnTestMode" class="btn-god px-8" onclick="toggleTestMode()">
                        <span id="testModeLabel">DISABLED</span>
                    </button>
                </div>
                <div id="testModeStatus" class="text-sm text-gray-600 italic"></div>
            </div>
        </div>

        <!-- Language Settings Panel -->
        <div class="god-panel mt-6">
            <div class="god-title">üåç NASTAVEN√ç JAZYKA</div>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-lg font-bold">Re≈æim Jazyka Syst√©mu</div>
                        <div class="text-sm text-gray-500">Vyberte jazykovou variantu pro cel√© rozhran√≠. Zmƒõna plat√≠ pro
                            v≈°echny termin√°ly v syst√©mu.</div>
                    </div>
                    <select id="languageModeSelect" class="bg-black border border-gray-700 p-2 text-white min-w-48"
                        onchange="setLanguageMode(this.value)">
                        <option value="cz">ƒåe≈°tina (v√Ωchoz√≠)</option>
                        <option value="en">English</option>
                        <option value="crazy">Crazy ƒåe≈°tina ü§™</option>
                        <option value="czech-iris">ƒåe≈°tina + IRIS Terminologie</option>
                    </select>
                </div>
                <div class="text-xs text-gray-500 border-t border-gray-800 pt-2 mt-2">
                    <strong>ƒåe≈°tina:</strong> Standardn√≠ ƒçesk√© p≈ôeklady pro v≈°echny u≈æivatele<br>
                    <strong>English:</strong> Anglick√© p≈ôeklady pro mezin√°rodn√≠ hr√°ƒçe<br>
                    <strong>Crazy ƒåe≈°tina:</strong> ≈†√≠len√°/z√°bavn√° varianta ƒçe≈°tiny pro LARP efekt<br>
                    <strong>ƒåe≈°tina + IRIS:</strong> LARP-specifick√° terminologie pro spr√°vce (UMYVADLO, BAHNO, atd.)
                </div>
            </div>
            <div class="flex items-center justify-between border-t border-gray-800 pt-4">
                <div>
                    <div class="text-sm font-bold">Vlastn√≠ P≈ôejmenov√°n√≠ Text≈Ø</div>
                    <div class="text-xs text-gray-500">Spr√°vci mohou p≈ôejmenovat texty v UI pomoc√≠ editaƒçn√≠ho re≈æimu
                    </div>
                </div>
                <button class="btn-god px-4" onclick="resetAllLabels()">
                    RESETOVAT V≈†ECHNY VLASTN√ç TEXTY
                </button>
            </div>
        </div>

        <!-- LLM Configuration -->
        <div class="god-panel mt-6">
            <div class="god-title">ü§ñ AI CONFIGURATION</div>
            <p class="text-sm text-gray-400 mb-4">Oddƒõlen√© profily pro jednotliv√© LLM role (√∫koly, soft/optimizer, HYPER
                autopilot). Ka≈æd√° karta umo≈æn√≠ vybrat poskytovatele, dostupn√Ω model, syst√©mov√Ω prompt a ulo≈æit vlastn√≠
                volbu.</p>
            <div class="grid grid-cols-3 gap-4">
                <div class="border border-gray-800 bg-black p-3 space-y-3">
                    <div class="text-lg font-bold text-yellow-400">üóíÔ∏è LLM PRO ZAD√ÅV√ÅN√ç √öKOL≈Æ</div>
                    <div class="text-xs text-gray-500">Hodnot√≠ a p≈ôij√≠m√° √∫koly (Task Evaluator).</div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Poskytovatel</label>
                        <select id="taskProvider" class="w-full bg-black border border-gray-700 p-2 text-white"
                            onchange="onProviderChanged('task')">
                            <option value="openai">OpenAI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="gemini">Gemini</option>
                        </select>
                    </div>
                    <div class="flex gap-2 items-end">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 mb-1">Model (dostupn√©)</label>
                            <select id="taskModelSelect" class="w-full bg-black border border-gray-700 p-2 text-white"
                                onchange="onModelSelected('task')">
                                <option value="">Naƒç√≠t√°m...</option>
                            </select>
                        </div>
                        <button class="btn-god px-3" onclick="refreshModels('task')">Obnovit</button>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Model (vlastn√≠ ID)</label>
                        <input id="taskModelInput"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="nap≈ô. gpt-4o" />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">System prompt</label>
                        <textarea id="taskSystemPrompt" rows="3"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="Jak m√° LLM hodnotit √∫koly"></textarea>
                    </div>
                    <button class="btn-god w-full" onclick="saveLLMConfig('task')">ULO≈ΩIT TASK LLM</button>
                </div>

                <div class="border border-gray-800 bg-black p-3 space-y-3">
                    <div class="text-lg font-bold text-yellow-400">üåø SOFT RE≈ΩIM / OPTIMIZER</div>
                    <div class="text-xs text-gray-500">P≈ôepisuje odpovƒõdi dle instrukc√≠ (m√≠rnƒõj≈°√≠ t√≥n).</div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Poskytovatel</label>
                        <select id="optimizerProvider" class="w-full bg-black border border-gray-700 p-2 text-white"
                            onchange="onProviderChanged('optimizer')">
                            <option value="openai">OpenAI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="gemini">Gemini</option>
                        </select>
                    </div>
                    <div class="flex gap-2 items-end">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 mb-1">Model (dostupn√©)</label>
                            <select id="optimizerModelSelect"
                                class="w-full bg-black border border-gray-700 p-2 text-white"
                                onchange="onModelSelected('optimizer')">
                                <option value="">Naƒç√≠t√°m...</option>
                            </select>
                        </div>
                        <button class="btn-god px-3" onclick="refreshModels('optimizer')">Obnovit</button>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Model (vlastn√≠ ID)</label>
                        <input id="optimizerModelInput"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="nap≈ô. mistralai/..." />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">System prompt</label>
                        <textarea id="optimizerSystemPrompt" rows="3"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="Jak m√° p≈ôepisovat odpovƒõdi"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Rewrite instrukce</label>
                        <textarea id="optimizerInstruction" rows="3"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="Nap≈ô. form√°ln√≠ t√≥n, struƒçnost..."></textarea>
                    </div>
                    <button class="btn-god w-full" onclick="saveLLMConfig('optimizer')">ULO≈ΩIT SOFT LLM</button>
                </div>

                <div class="border border-gray-800 bg-black p-3 space-y-3">
                    <div class="text-lg font-bold text-yellow-400">üöÄ HYPER / AUTOPILOT</div>
                    <div class="text-xs text-gray-500">Plnƒõ automatick√© odpovƒõdi (Autopilot/HYPER re≈æim).</div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Poskytovatel</label>
                        <select id="hyperProvider" class="w-full bg-black border border-gray-700 p-2 text-white"
                            onchange="onProviderChanged('hyper')">
                            <option value="openai">OpenAI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="gemini">Gemini</option>
                        </select>
                    </div>
                    <div class="flex gap-2 items-end">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 mb-1">Model (dostupn√©)</label>
                            <select id="hyperModelSelect" class="w-full bg-black border border-gray-700 p-2 text-white"
                                onchange="onModelSelected('hyper')">
                                <option value="">Naƒç√≠t√°m...</option>
                            </select>
                        </div>
                        <button class="btn-god px-3" onclick="refreshModels('hyper')">Obnovit</button>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Model (vlastn√≠ ID)</label>
                        <input id="hyperModelInput"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="nap≈ô. google/..." />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">System prompt</label>
                        <textarea id="hyperSystemPrompt" rows="3"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="Jak m√° autopilot reagovat"></textarea>
                    </div>
                    <button class="btn-god w-full" onclick="saveLLMConfig('hyper')">ULO≈ΩIT HYPER LLM</button>
                </div>
            </div>

            <!-- API Keys Section -->
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="text-sm text-yellow-500 mb-3">üîë API KEYS (ulo≈æeno v .env)</div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">OPENAI API KEY</label>
                        <input type="password" id="openaiKey"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="sk-..." autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">OPENROUTER API KEY</label>
                        <input type="password" id="openrouterKey"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="sk-or-..." autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">GEMINI API KEY</label>
                        <input type="password" id="geminiKey"
                            class="w-full bg-black border border-gray-700 p-2 text-white font-mono text-sm"
                            placeholder="AIza..." autocomplete="off">
                    </div>
                </div>
                <div class="text-xs text-gray-600 mt-2 italic flex items-center justify-between">
                    <span>‚ö†Ô∏è Kl√≠ƒçe se ukl√°daj√≠ do .env/SystemConfig na serveru. Vƒõt≈°inou vy≈æaduj√≠ restart
                        serveru.</span>
                    <button class="btn-god px-4" onclick="saveApiKeys()">ULO≈ΩIT API KEYS</button>
                </div>
            </div>
        </div>

        <!--System Info -->
        <div class="god-panel mt-6">
            <div class="god-title">‚ÑπÔ∏è SYSTEM INFORMATION</div>
            <div class="grid grid-cols-3 gap-4 text-sm font-mono">
                <div>
                    <div class="text-gray-500">Version</div>
                    <div class="text-white">Phase 25.0</div>
                </div>
                <div>
                    <div class="text-gray-500">Total Users</div>
                    <div class="text-white" id="sysUserCount">--</div>
                </div>
                <div>
                    <div class="text-gray-500">Database</div>
                    <div class="text-white">SQLite (iris.db)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- VIEW: ECONOMY -->
<div id="view-economy" class="view-container hidden">
    <div class="god-panel">
        <div class="god-title">GLOBAL ECONOMY MANIPULATION</div>
        <div class="grid grid-cols-4 gap-4 mb-6">
            <button class="btn-god text-green-400 border-green-400" onclick="injectGlobal(100)">STIMULUS
                (+100)</button>
            <button class="btn-god text-green-400 border-green-400" onclick="injectGlobal(1000)">LARGE STIMULUS
                (+1000)</button>
            <button class="btn-god text-red-500 border-red-500" onclick="injectGlobal(-100)">TAXATION
                (-100)</button>
            <button class="btn-god text-red-500 border-red-500" onclick="resetEconomy()">RESET ALL
                CREDITS</button>
        </div>

        <div class="god-title mt-4">TASK REWARD RULES</div>
        <p class="text-xs text-gray-400 mb-3">V√Ωchoz√≠ odmƒõny se aplikuj√≠ p≈ôi vy≈æ√°d√°n√≠ √∫kolu podle levelu u≈æivatele.</p>
        <div class="grid grid-cols-5 gap-3">
            <div>
                <label class="text-xs text-gray-500">V√Ωchoz√≠</label>
                <input id="rewardDefault" type="number" class="w-full bg-black border border-gray-700 p-2 text-white" />
            </div>
            <div>
                <label class="text-xs text-gray-500">LOW</label>
                <input id="rewardLow" type="number" class="w-full bg-black border border-gray-700 p-2 text-white" />
            </div>
            <div>
                <label class="text-xs text-gray-500">MID</label>
                <input id="rewardMid" type="number" class="w-full bg-black border border-gray-700 p-2 text-white" />
            </div>
            <div>
                <label class="text-xs text-gray-500">HIGH</label>
                <input id="rewardHigh" type="number" class="w-full bg-black border border-gray-700 p-2 text-white" />
            </div>
            <div>
                <label class="text-xs text-gray-500">PARTY</label>
                <input id="rewardParty" type="number" class="w-full bg-black border border-gray-700 p-2 text-white" />
            </div>
        </div>
        <div class="flex justify-end mt-3">
            <button class="btn-god" onclick="saveTaskRewards()">ULO≈ΩIT ODMƒöNY</button>
        </div>

        <div class="god-title mt-8">INDIVIDUAL EDITOR</div>
        <table class="w-full text-left text-sm border border-gray-800">
            <thead class="bg-gray-900 text-yellow-600">
                <tr>
                    <th>USER</th>
                    <th>CREDITS</th>
                    <th>STATUS</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody id="rootEcoTable"></tbody>
        </table>
    </div>
</div>
</div>

<!-- VIEW: TIME (CHRONOS) -->
<div id="view-time" class="view-container hidden">
    <div class="god-panel w-1/2 mx-auto">
        <div class="god-title">TIME MANIPULATION</div>
        <div class="text-center mb-8">
            <div class="text-6xl font-bold mb-2 text-white" id="bigShift">0</div>
            <div class="text-sm text-gray-500">CURRENT SHIFT OFFSET</div>
        </div>

        <div class="space-y-4">
            <input type="number" id="targetShift" class="w-full bg-gray-900 border border-yellow-700 p-2 text-white"
                placeholder="Target Shift (0-7)">
            <button class="btn-god w-full" onclick="setShift()">JUMP TO SHIFT</button>
        </div>

        <div class="mt-8 border-t border-gray-800 pt-4">
            <label class="block mb-2 text-red-500">CHERNOBYL OVERRIDE</label>
            <input type="range" min="0" max="200" value="0" class="w-full accent-red-600"
                oninput="sendChernobylLevel(this.value)">
            <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>0%</span>
                <span>100%</span>
                <span>MELTDOWN</span>
            </div>
        </div>
    </div>
</div>
</div>

<!-- VIEW: SIMULATION (LLM Hour Test) -->
<div id="view-simulation" class="view-container hidden">
    <div class="god-panel">
        <div class="god-title">üß™ LLM HOUR SIMULATION</div>
        <p class="text-sm text-gray-400 mb-4">
            Komplexn√≠ hodinov√Ω testovac√≠ sc√©n√°≈ô simuluj√≠c√≠ v≈°ech 20 u≈æivatel≈Ø pomoc√≠ Gemini 2.5 Flash.
            U≈æivatel√© pracuj√≠ 10 minut, pos√≠laj√≠ zpr√°vy ka≈æd√© 3 minuty, chod√≠ na pauzy.
            Agenti odpov√≠daj√≠ okam≈æitƒõ. Spr√°vci prov√°d√≠ admin akce.
        </p>

        <!-- Status Panel -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-900 p-4 border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">STAV</div>
                <div class="text-2xl font-bold" id="simState">IDLE</div>
            </div>
            <div class="bg-gray-900 p-4 border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">PROGRESS</div>
                <div class="text-2xl font-bold text-yellow-500" id="simProgress">0%</div>
            </div>
            <div class="bg-gray-900 p-4 border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">UPLYNUL√ù ƒåAS</div>
                <div class="text-2xl font-bold" id="simElapsed">00:00</div>
            </div>
            <div class="bg-gray-900 p-4 border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">ZB√ùV√Å</div>
                <div class="text-2xl font-bold" id="simRemaining">--:--</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-800 h-4 mb-6 border border-gray-700">
            <div class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 transition-all duration-1000"
                id="simProgressBar" style="width: 0%"></div>
        </div>

        <!-- Control Buttons -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <button class="btn-god border-green-500 text-green-500 hover:bg-green-900 py-3"
                onclick="startSimulation(false)" id="btnStartFull">
                ‚ñ∂Ô∏è SPUSTIT (1 HODINA)
            </button>
            <button class="btn-god border-blue-500 text-blue-500 hover:bg-blue-900 py-3" onclick="startSimulation(true)"
                id="btnStartShort">
                ‚è±Ô∏è SHORT TEST (5 MIN)
            </button>
            <button class="btn-god border-red-500 text-red-500 hover:bg-red-900 py-3" onclick="stopSimulation()"
                id="btnStop" disabled>
                ‚èπÔ∏è ZASTAVIT
            </button>
            <button class="btn-god py-3" onclick="refreshSimStatus()">
                üîÑ REFRESH STATUS
            </button>
        </div>

        <!-- Stats Panel -->
        <div class="god-title mt-4">üìä STATISTIKY</div>
        <div class="grid grid-cols-6 gap-3 mb-6">
            <div class="bg-black p-3 border border-gray-800 text-center">
                <div class="text-xs text-gray-500">USERS</div>
                <div class="text-xl font-bold text-blue-400" id="simUsers">0</div>
            </div>
            <div class="bg-black p-3 border border-gray-800 text-center">
                <div class="text-xs text-gray-500">AGENTS</div>
                <div class="text-xl font-bold text-pink-400" id="simAgents">0</div>
            </div>
            <div class="bg-black p-3 border border-gray-800 text-center">
                <div class="text-xs text-gray-500">ADMINS</div>
                <div class="text-xl font-bold text-yellow-400" id="simAdmins">0</div>
            </div>
            <div class="bg-black p-3 border border-gray-800 text-center">
                <div class="text-xs text-gray-500">ZPR√ÅVY</div>
                <div class="text-xl font-bold text-green-400" id="simMessages">0</div>
            </div>
            <div class="bg-black p-3 border border-gray-800 text-center">
                <div class="text-xs text-gray-500">√öKOLY</div>
                <div class="text-xl font-bold text-purple-400" id="simTasks">0</div>
            </div>
            <div class="bg-black p-3 border border-gray-800 text-center">
                <div class="text-xs text-gray-500">CHYBY</div>
                <div class="text-xl font-bold text-red-400" id="simErrors">0</div>
            </div>
        </div>

        <!-- Live Log -->
        <div class="god-title">üìú LIVE LOG</div>
        <div id="simLogStream"
            class="font-mono text-xs text-gray-400 h-64 overflow-y-auto p-3 bg-black border border-gray-800">
            <div class="text-gray-600">ƒåek√°m na spu≈°tƒõn√≠ simulace...</div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="god-panel mt-6">
        <div class="god-title">üìÇ HISTORIE SIMULAC√ç</div>
        <div id="simHistory" class="space-y-2">
            <div class="text-gray-600 text-sm">Naƒç√≠t√°m historii...</div>
        </div>
    </div>
</div>

<!-- VIEW: LORE (Documentation) -->
<div id="view-lore" class="view-container hidden">
    <div class="god-panel">
        <div class="god-title">LORE ARCHIVE</div>
        <div class="flex justify-between items-center mb-4">
            <p class="text-sm text-gray-400">Integrovan√Ω prohl√≠≈æeƒç dokumentace projektu HLIN√çK.
            </p>
            <a href="/organizer-wiki/" target="_blank"
                class="btn-god border-yellow-500 text-yellow-500 hover:bg-yellow-900 px-4">
                üöÄ OTEV≈ò√çT ORGANIZER WIKI (Phase 34)
            </a>
        </div>
        <div class="lore-embed">
            <iframe class="lore-frame" src="/organizer-wiki/index.html" title="HLIN√çK Organizer Wiki"
                loading="lazy"></iframe>
        </div>
    </div>
</div>

<!-- VIEW: SURVEILLANCE -->
<div id="view-surveillance" class="view-container hidden">
    <div class="god-title">PANOPTICON 8x8</div>
    <div class="grid grid-cols-4 gap-2 h-full pb-20" id="rootGrid">
        <!-- 8 Sessions -->
    </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/socket_client.js"></script>
<script>
    // Root UI Logic - Simplified/Inline
    // Get token: URL param > sessionStorage
    const urlParams = new URLSearchParams(window.location.search);
    let token = urlParams.get('token') || sessionStorage.getItem('token');

    if (token) {
        sessionStorage.setItem('token', token);
    } else {
        window.location.href = '/';
    }

    // --- STATE ---
    let currentView = 'dashboard';
    let rootState = {};
    let isPanic = false;

    // --- SOCKET ---
    const wsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/connect';
    const client = new SocketClient(wsUrl, handlePayload, (s) => { console.log("WS", s) });
    client.connect(token);

    // Init Constants
    setTimeout(() => fetchRootState(), 1000);

    async function fetchRootState() {
        try {
            const res = await fetch('/api/admin/root/state', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            rootState = data;
            document.getElementById('inTax').value = data.tax_rate;
            document.getElementById('inPower').value = data.power_cap;

            if (data.task_rewards) {
                document.getElementById('rewardDefault').value = data.task_rewards.default;
                document.getElementById('rewardLow').value = data.task_rewards.low;
                document.getElementById('rewardMid').value = data.task_rewards.mid;
                document.getElementById('rewardHigh').value = data.task_rewards.high;
                document.getElementById('rewardParty').value = data.task_rewards.party;
            }
        } catch (e) { console.error(e); }
    }

    function buildConstantsPayload() {
        const rewards = rootState.task_rewards || {};
        const costs = rootState.costs || {};
        return {
            tax_rate: parseFloat(document.getElementById('inTax').value),
            power_cap: parseFloat(document.getElementById('inPower').value),
            temp_threshold: rootState.temp_threshold || 350,
            temp_reset_val: rootState.temp_reset_val || 80,
            temp_min: rootState.temp_min || 20,
            cost_base: costs.base || 10,
            cost_user: costs.user || 5,
            cost_autopilot: costs.autopilot || 10,
            cost_low_latency: costs.low_latency || 30,
            cost_optimizer: costs.optimizer || 15,
            task_reward_default: parseInt(document.getElementById('rewardDefault').value || rewards.default || 0),
            task_reward_low: parseInt(document.getElementById('rewardLow').value || rewards.low || 0),
            task_reward_mid: parseInt(document.getElementById('rewardMid').value || rewards.mid || 0),
            task_reward_high: parseInt(document.getElementById('rewardHigh').value || rewards.high || 0),
            task_reward_party: parseInt(document.getElementById('rewardParty').value || rewards.party || 0),
        };
    }

    window.applySystemConstants = async () => {
        const payload = buildConstantsPayload();
        await fetch('/api/admin/root/update_constants', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        });
        alert("PHYSICS UPDATED");
    };

    window.saveTaskRewards = async () => {
        const payload = buildConstantsPayload();
        await fetch('/api/admin/root/update_constants', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        });
        alert('Odmƒõny pro √∫koly aktualizov√°ny');
        rootState.task_rewards = {
            default: payload.task_reward_default,
            low: payload.task_reward_low,
            mid: payload.task_reward_mid,
            high: payload.task_reward_high,
            party: payload.task_reward_party
        };
    };

    function handlePayload(data) {
        logEvent(data.type);

        // Handle translation updates
        if (data.type === 'translation_update' || data.type === 'language_change' || data.type === 'translations_reset') {
            if (window.translationManager) {
                window.translationManager.handleTranslationUpdate(data);
            }
            if (data.type === 'language_change') {
                const select = document.getElementById('languageModeSelect');
                if (select) select.value = data.language_mode;
            }
            return;
        }

        if (data.type === 'gamestate_update') {
            document.getElementById('valShift').innerText = data.shift;
            document.getElementById('bigShift').innerText = data.shift;
            document.getElementById('valChernobyl').innerText = data.chernobyl + "%";
            if (data.panic_global !== undefined) {
                isPanic = data.panic_global;
                updatePanicBtn();
            }
        }
        if (data.type === 'message') {
            // Update Panopticon
            const sessId = data.session_id || 1;
            const chatDiv = document.getElementById(`rootChat-${sessId}`);
            if (chatDiv) {
                const row = document.createElement('div');
                row.className = `text-xs mb-1 ${data.role === 'agent' ? 'text-pink-400' : 'text-green-400'}`;
                row.innerText = `${data.sender}: ${data.content}`;
                chatDiv.appendChild(row);
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }
        }
    }

    function logEvent(type) {
        // Filter out noisy gamestate_update messages
        if (type === 'gamestate_update') return;

        const div = document.createElement('div');
        div.innerText = `${new Date().toLocaleTimeString()} - ${type}`;
        const logStream = document.getElementById('logStream');
        logStream.prepend(div);

        // Keep log size manageable (max 50 entries)
        while (logStream.children.length > 50) {
            logStream.removeChild(logStream.lastChild);
        }
    }

    // --- NAVIGATION ---
    window.switchView = function (view) {
        document.querySelectorAll('.view-container').forEach(e => e.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(`nav-${view}`).classList.add('active');
        currentView = view;

        if (view === 'economy') refreshEconomy();
        if (view === 'surveillance') initGrid();
    }

    // --- ACTIONS ---
    window.triggerShift = () => client.send({ type: 'shift_command' });
    window.injectGlobal = async (amt) => {
        if (!confirm(`Inject ${amt} credits to ALL users?`)) return;
        // Need new API for this? Or loop in JS?
        // Loop in JS is slow. Better API.
        // For now, let's just use loop as iterating 8 users is fine.
        // But better implementation: Backend endpoint.
        // Let's assume we have /api/admin/economy/global_bonus
        // I will create that if needed. For now, loop frontend?
        // We can just reuse `ecoAction` inside a loop from the table data.
        const users = await fetchUsers();
        for (const u of users) {
            await fetch('/api/admin/economy/bonus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ user_id: u.id, amount: amt, reason: "GOD STIMULUS" })
            });
        }
        alert("EXECUTION COMPLETE");
        refreshEconomy();
    };

    window.resetEconomy = async () => {
        // Loop set to 100? or 0?
        alert("Not implemented yet - Requires specific endpoint to be safe.");
    };

    window.broadcastMsg = () => {
        const msg = prompt("GLOBAL MESSAGE:");
        if (msg) client.send({ type: 'admin_broadcast', content: msg });
        // Note: sockets.py needs to handle 'admin_broadcast' or similar. 
        // Existing logic supports 'broadcast_global' via python but not direct socket cmd for admin maybe?
        // I'll check sockets.py later.
    };

    window.triggerReset = () => {
        if (prompt("TYPE 'NUKE' TO CONFIRM") === 'NUKE') {
            client.send({ type: 'reset_game' });
        }
    };

    window.togglePanic = () => {
        const action = isPanic ? "DEACTIVATE PANIC MODE?" : "ACTIVATE EMERGENCY CENSORSHIP?";
        if (confirm(action)) {
            // Optimistic update
            isPanic = !isPanic;
            updatePanicBtn();
            client.send({ type: 'panic_command', enabled: isPanic });
        }
    };

    function updatePanicBtn() {
        const btn = document.getElementById('btnPanic');
        if (!btn) return;
        if (isPanic) {
            btn.style.background = '#f00';
            btn.style.color = '#fff';
            btn.innerText = "üö® PANIC ACTIVE üö®";
            btn.classList.remove('animate-pulse');
        } else {
            btn.style.background = 'transparent';
            btn.style.color = '#f00';
            btn.innerText = "‚ö†Ô∏è PANIC MODE ‚ö†Ô∏è";
            btn.classList.add('animate-pulse');
        }
    }

    window.restartServer = async () => {
        if (!confirm("RESTART SERVER? All connections will be dropped temporarily.")) return;
        try {
            const res = await fetch('/api/admin/root/restart', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            alert(data.message);
            setTimeout(() => location.reload(), 5000);
        } catch (e) {
            alert("Restart failed: " + e);
        }
    };

    window.factoryReset = async () => {
        if (prompt("THIS WILL DELETE ALL DATA AND RESTART WITH DEFAULTS.\nType 'FACTORY RESET' to confirm:") !== 'FACTORY RESET') return;
        try {
            const res = await fetch('/api/admin/root/factory_reset', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            alert(data.message);
            setTimeout(() => location.reload(), 8000);
        } catch (e) {
            alert("Factory reset failed: " + e);
        }
    };

    window.setShift = () => {
        const target = document.getElementById('targetShift').value;
        if (target === '' || isNaN(parseInt(target))) {
            alert('Enter a valid shift value (0-7)');
            return;
        }
        client.send({ type: 'set_shift_command', value: parseInt(target) });
        document.getElementById('bigShift').innerText = target;
    };

    window.sendChernobylLevel = (val) => {
        client.send({ type: 'chernobyl_command', level: parseInt(val) });
        document.getElementById('valChernobyl').innerText = val + "%";
    }

    // --- TEST MODE TOGGLE ---
    let testModeActive = false;

    window.toggleTestMode = async () => {
        testModeActive = !testModeActive;

        // Send WebSocket command
        client.send({
            type: 'test_mode_toggle',
            enabled: testModeActive
        });

        updateTestModeUI();
    };

    function updateTestModeUI() {
        const btn = document.getElementById('btnTestMode');
        const label = document.getElementById('testModeLabel');
        const status = document.getElementById('testModeStatus');

        if (testModeActive) {
            label.innerText = 'ENABLED';
            btn.classList.add('border-green-500', 'text-green-500');
            btn.classList.remove('border-gray-700');
            status.innerText = '‚úÖ Quick login buttons will appear on login screen';
            status.classList.remove('text-gray-600');
            status.classList.add('text-green-500');
        } else {
            label.innerText = 'DISABLED';
            btn.classList.remove('border-green-500', 'text-green-500');
            btn.classList.add('border-gray-700');
            status.innerText = '‚ùå Standard password input required';
            status.classList.remove('text-green-500');
            status.classList.add('text-gray-600');
        }
    }

    // --- AI CONFIGURATION ---
    const llmRoles = {
        task: {
            providerId: 'taskProvider',
            modelSelectId: 'taskModelSelect',
            modelInputId: 'taskModelInput',
            promptId: 'taskSystemPrompt'
        },
        optimizer: {
            providerId: 'optimizerProvider',
            modelSelectId: 'optimizerModelSelect',
            modelInputId: 'optimizerModelInput',
            promptId: 'optimizerSystemPrompt',
            instructionId: 'optimizerInstruction'
        },
        hyper: {
            providerId: 'hyperProvider',
            modelSelectId: 'hyperModelSelect',
            modelInputId: 'hyperModelInput',
            promptId: 'hyperSystemPrompt'
        }
    };

    function getAuthHeaders() {
        return { 'Authorization': `Bearer ${token}` };
    }

    window.onProviderChanged = (role) => {
        refreshModels(role);
    }

    window.onModelSelected = (role) => {
        const config = llmRoles[role];
        const select = document.getElementById(config.modelSelectId);
        const input = document.getElementById(config.modelInputId);
        if (select && input) {
            input.value = select.value;
        }
    }

    window.refreshModels = async (role, selectedModel = '') => {
        const config = llmRoles[role];
        if (!config) return;

        const provider = document.getElementById(config.providerId)?.value;
        const select = document.getElementById(config.modelSelectId);
        const input = document.getElementById(config.modelInputId);

        if (!provider || !select) return;
        select.innerHTML = `<option value="">Naƒç√≠t√°m...</option>`;

        try {
            const res = await fetch(`/api/admin/llm/models/${provider}`, { headers: getAuthHeaders() });
            const models = await res.json();
            select.innerHTML = '';

            if (models.length === 0) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.innerText = '≈Ω√°dn√© modely (zadejte ruƒçnƒõ)';
                select.appendChild(opt);
            }

            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                select.appendChild(opt);
            });

            if (selectedModel && models.includes(selectedModel)) {
                select.value = selectedModel;
            }
        } catch (e) {
            console.error('Model fetch failed', e);
            select.innerHTML = '<option value="">Chyba naƒç√≠t√°n√≠</option>';
        }

        if (input) {
            input.value = selectedModel || select.value || '';
        }
    }

    function applyConfigToUI(role, cfg) {
        const config = llmRoles[role];
        if (!config || !cfg) return;

        const providerSelect = document.getElementById(config.providerId);
        const promptField = document.getElementById(config.promptId);
        const modelInput = document.getElementById(config.modelInputId);

        if (providerSelect && cfg.provider) providerSelect.value = cfg.provider;
        if (promptField && cfg.system_prompt !== undefined) promptField.value = cfg.system_prompt || '';
        if (modelInput && cfg.model_name) modelInput.value = cfg.model_name;

        refreshModels(role, cfg.model_name || '');

        if (config.instructionId && cfg.prompt !== undefined) {
            const instructionField = document.getElementById(config.instructionId);
            if (instructionField) instructionField.value = cfg.prompt || '';
        }
    }

    function gatherRoleConfig(role) {
        const cfg = llmRoles[role];
        const provider = document.getElementById(cfg.providerId)?.value;
        const select = document.getElementById(cfg.modelSelectId);
        const input = document.getElementById(cfg.modelInputId);
        const systemPrompt = document.getElementById(cfg.promptId)?.value || '';
        const modelName = (input?.value || '').trim() || (select?.value || '').trim();

        return { provider, modelName, systemPrompt };
    }

    window.saveLLMConfig = async (role) => {
        const cfg = llmRoles[role];
        if (!cfg) return;
        const { provider, modelName, systemPrompt } = gatherRoleConfig(role);
        if (!provider || !modelName) {
            alert('Vypl≈àte poskytovatele i model.');
            return;
        }

        const payload = {
            provider,
            model_name: modelName,
            system_prompt: systemPrompt
        };

        if (cfg.instructionId) {
            payload.prompt = document.getElementById(cfg.instructionId)?.value || '';
        }

        try {
            const res = await fetch(`/api/admin/llm/config/${role}`, {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(await res.text());
            alert('‚úÖ LLM konfigurace ulo≈æena');
        } catch (e) {
            console.error(e);
            alert('‚ùå Ulo≈æen√≠ se nezda≈ôilo');
        }
    };

    async function loadLLMConfig() {
        try {
            const res = await fetch('/api/admin/llm/config', { headers: getAuthHeaders() });
            const data = await res.json();
            applyConfigToUI('task', data.task);
            applyConfigToUI('hyper', data.hyper);
            applyConfigToUI('optimizer', data.optimizer);
        } catch (e) {
            console.error('Config load failed', e);
        }
    }

    async function loadApiKeys() {
        try {
            const res = await fetch('/api/admin/llm/keys', { headers: getAuthHeaders() });
            const data = await res.json();
            const placeholders = {
                openai: 'sk-...',
                openrouter: 'sk-or-...',
                gemini: 'AIza...'
            };
            [['openai', 'openaiKey'], ['openrouter', 'openrouterKey'], ['gemini', 'geminiKey']]
                .forEach(([provider, inputId]) => {
                    const input = document.getElementById(inputId);
                    if (!input) return;
                    input.value = '';
                    input.placeholder = data?.[provider] || placeholders[provider];
                });
        } catch (e) {
            console.error('Key fetch failed', e);
        }
    }

    window.saveApiKeys = async () => {
        const providers = ['openai', 'openrouter', 'gemini'];
        const updates = [];

        providers.forEach((provider) => {
            const input = document.getElementById(`${provider}Key`);
            if (input && input.value.trim()) {
                updates.push({ provider, key: input.value.trim() });
            }
        });

        if (updates.length === 0) {
            alert('Zadejte alespo≈à jeden API kl√≠ƒç.');
            return;
        }

        try {
            for (const upd of updates) {
                const res = await fetch('/api/admin/llm/keys', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(upd)
                });
                if (!res.ok) throw new Error(await res.text());
            }
            alert('‚úÖ API kl√≠ƒçe ulo≈æeny');
            loadApiKeys();
        } catch (e) {
            console.error(e);
            alert('‚ùå Ulo≈æen√≠ kl√≠ƒç≈Ø selhalo');
        }
    }

    async function hydrateTestMode() {
        try {
            const res = await fetch('/api/admin/root/ai_config', { headers: getAuthHeaders() });
            const data = await res.json();
            if (data.test_mode !== undefined) {
                testModeActive = data.test_mode;
                updateTestModeUI();
            }
            const optimizerField = document.getElementById('optimizerInstruction');
            if (optimizerField && !optimizerField.value && data.optimizer_prompt) {
                optimizerField.value = data.optimizer_prompt;
            }
        } catch (e) {
            console.error('Test mode hydrate failed', e);
        }
    }

    // Call on init
    setTimeout(() => {
        loadLLMConfig();
        loadApiKeys();
        hydrateTestMode();
    }, 1000);

    // --- ECONOMY TABLE ---
    async function fetchUsers() {
        const res = await fetch('/api/admin/data/users', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        return await res.json();
    }

    async function refreshEconomy() {
        const users = await fetchUsers();
        const tbody = document.getElementById('rootEcoTable');
        tbody.innerHTML = '';
        users.forEach(u => {
            const tr = document.createElement('tr');
            tr.className = "border-b border-gray-800 hover:bg-gray-900";
            tr.innerHTML = `
                 <td class="p-2 font-bold">${u.username}</td>
                 <td class="p-2 text-yellow-500">${u.credits}</td>
                 <td class="p-2">${u.status_level}</td>
                 <td class="p-2">
                     <button onclick="ecoAction('bonus', ${u.id}, 100)" class="text-green-500 text-xs">[+100]</button>
                     <button onclick="ecoAction('fine', ${u.id}, 100)" class="text-red-500 text-xs">[-100]</button>
                 </td>
             `;
            tbody.appendChild(tr);
        });
    }

    window.ecoAction = async (type, uid, amt) => {
        await fetch(`/api/admin/economy/${type}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ user_id: uid, amount: amt, reason: "ROOT" })
        });
        refreshEconomy();
    }

    // --- GRID ---
    function initGrid() {
        const grid = document.getElementById('rootGrid');
        if (grid.children.length > 0) return; // already init

        for (let i = 1; i <= 8; i++) {
            grid.innerHTML += `
                <div class="border border-gray-800 bg-black flex flex-col h-40">
                    <div class="bg-gray-900 px-2 py-1 text-xs text-gray-500 flex justify-between">
                        <span>SESSION ${i}</span>
                        <span id="label-sess-${i}">Active</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-1 font-mono text-[10px]" id="rootChat-${i}"></div>
                </div>
            `;
        }
    }

    // --- LANGUAGE SETTINGS ---
    const languageLabels = {
        'cz': 'ƒåe≈°tina',
        'en': 'English',
        'crazy': 'Crazy ƒåe≈°tina ü§™',
        'czech-iris': 'ƒåe≈°tina + IRIS'
    };

    window.setLanguageMode = async (mode) => {
        const status = document.getElementById('languageStatus');
        try {
            const res = await fetch('/api/translations/language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ language_mode: mode })
            });

            if (res.ok) {
                const label = languageLabels[mode] || mode;
                status.innerText = '‚úÖ Jazyk √∫spƒõ≈°nƒõ zmƒõnƒõn na: ' + label;
                status.classList.remove('text-gray-600', 'text-red-500');
                status.classList.add('text-green-500');
            } else {
                const data = await res.json();
                status.innerText = '‚ùå Chyba: ' + (data.detail || 'Nepoda≈ôilo se zmƒõnit jazyk');
                status.classList.remove('text-gray-600', 'text-green-500');
                status.classList.add('text-red-500');
            }
        } catch (e) {
            status.innerText = '‚ùå Chyba p≈ôipojen√≠';
            status.classList.remove('text-gray-600', 'text-green-500');
            status.classList.add('text-red-500');
        }
    };

    window.resetAllLabels = async () => {
        if (!confirm('Opravdu chcete resetovat v≈°echny vlastn√≠ texty? Tuto akci nelze vr√°tit zpƒõt.')) return;

        const status = document.getElementById('languageStatus');
        try {
            const res = await fetch('/api/translations/reset-labels', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                status.innerText = '‚úÖ V≈°echny vlastn√≠ texty byly resetov√°ny';
                status.classList.remove('text-gray-600', 'text-red-500');
                status.classList.add('text-green-500');
            } else {
                status.innerText = '‚ùå Nepoda≈ôilo se resetovat texty';
                status.classList.remove('text-gray-600', 'text-green-500');
                status.classList.add('text-red-500');
            }
        } catch (e) {
            status.innerText = '‚ùå Chyba p≈ôipojen√≠';
        }
    };

    // Load current language setting
    window.loadLanguageSettings = async () => {
        try {
            const res = await fetch('/api/translations/language-options', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                const select = document.getElementById('languageModeSelect');
                if (select && data.current) {
                    select.value = data.current;
                }
            }
        } catch (e) { console.warn("Language settings load failed"); }
    };

    // Call on init
    setTimeout(loadLanguageSettings, 1200);

    // ============================================
    // SIMULATION CONTROLS
    // ============================================

    let simStatusInterval = null;

    window.startSimulation = async (shortTest) => {
        const mode = shortTest ? 'SHORT TEST (5 min)' : 'FULL (1 hodina)';
        if (!confirm(`Spustit simulaci ${mode}?\n\nSimulace bude bƒõ≈æet na pozad√≠.`)) return;

        try {
            const res = await fetch('/api/admin/simulation/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ short_test: shortTest })
            });

            const data = await res.json();

            if (data.status === 'started') {
                addSimLog('SUCCESS', `Simulace spu≈°tƒõna: ${mode}`);
                updateSimButtons(true);
                startSimStatusPolling();
            } else {
                addSimLog('ERROR', data.message || 'Nepoda≈ôilo se spustit simulaci');
            }

            if (data.data) {
                updateSimStatus(data.data);
            }
        } catch (e) {
            addSimLog('ERROR', `Chyba: ${e.message}`);
        }
    };

    window.stopSimulation = async () => {
        if (!confirm('Zastavit bƒõ≈æ√≠c√≠ simulaci?')) return;

        try {
            const res = await fetch('/api/admin/simulation/stop', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await res.json();
            addSimLog('INFO', data.message || 'Zastavuji simulaci...');

            if (data.data) {
                updateSimStatus(data.data);
            }
        } catch (e) {
            addSimLog('ERROR', `Chyba: ${e.message}`);
        }
    };

    window.refreshSimStatus = async () => {
        try {
            const res = await fetch('/api/admin/simulation/status', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await res.json();
            updateSimStatus(data);
        } catch (e) {
            console.error('Simulation status error:', e);
        }
    };

    function updateSimStatus(data) {
        // State
        const stateEl = document.getElementById('simState');
        if (stateEl) {
            stateEl.innerText = (data.state || 'idle').toUpperCase();
            stateEl.className = 'text-2xl font-bold';
            if (data.state === 'running') stateEl.classList.add('text-green-500');
            else if (data.state === 'failed') stateEl.classList.add('text-red-500');
            else if (data.state === 'completed') stateEl.classList.add('text-blue-500');
            else stateEl.classList.add('text-gray-500');
        }

        // Progress
        const progress = data.progress_percent || 0;
        document.getElementById('simProgress').innerText = `${progress.toFixed(1)}%`;
        document.getElementById('simProgressBar').style.width = `${progress}%`;

        // Time
        const elapsed = data.elapsed_seconds || 0;
        const remaining = data.remaining_seconds || 0;
        document.getElementById('simElapsed').innerText = formatTime(elapsed);
        document.getElementById('simRemaining').innerText = formatTime(remaining);

        // Stats from summary
        if (data.summary && data.summary.stats) {
            const stats = data.summary.stats;
            document.getElementById('simUsers').innerText = stats.users_active || 0;
            document.getElementById('simAgents').innerText = stats.agents_active || 0;
            document.getElementById('simAdmins').innerText = stats.admins_active || 0;
            document.getElementById('simMessages').innerText = stats.total_messages || 0;
            document.getElementById('simTasks').innerText = stats.total_tasks || 0;
            document.getElementById('simErrors').innerText = stats.total_errors || 0;
        }

        // Update buttons based on state
        const isRunning = data.state === 'running' || data.state === 'stopping';
        updateSimButtons(isRunning);

        // Stop polling if simulation ended
        if (data.state !== 'running' && data.state !== 'stopping' && simStatusInterval) {
            stopSimStatusPolling();
        }
    }

    function updateSimButtons(isRunning) {
        const btnStartFull = document.getElementById('btnStartFull');
        const btnStartShort = document.getElementById('btnStartShort');
        const btnStop = document.getElementById('btnStop');

        if (btnStartFull) btnStartFull.disabled = isRunning;
        if (btnStartShort) btnStartShort.disabled = isRunning;
        if (btnStop) btnStop.disabled = !isRunning;

        // Visual feedback
        if (isRunning) {
            btnStartFull?.classList.add('opacity-50');
            btnStartShort?.classList.add('opacity-50');
            btnStop?.classList.remove('opacity-50');
        } else {
            btnStartFull?.classList.remove('opacity-50');
            btnStartShort?.classList.remove('opacity-50');
            btnStop?.classList.add('opacity-50');
        }
    }

    function startSimStatusPolling() {
        if (simStatusInterval) clearInterval(simStatusInterval);
        // Poll every 5 seconds to reduce server load
        // Note: Consider WebSocket for real-time updates in high-traffic scenarios
        simStatusInterval = setInterval(async () => {
            await refreshSimStatus();
            await fetchSimLogs();
        }, 5000);
    }

    function stopSimStatusPolling() {
        if (simStatusInterval) {
            clearInterval(simStatusInterval);
            simStatusInterval = null;
        }
    }

    async function fetchSimLogs() {
        try {
            const res = await fetch('/api/admin/simulation/logs?limit=50', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            if (data.logs && data.logs.length > 0) {
                const logDiv = document.getElementById('simLogStream');
                logDiv.innerHTML = '';

                data.logs.slice(-30).forEach(log => {
                    const time = log.time ? log.time.split('T')[1]?.split('.')[0] : '';
                    const levelColors = {
                        'INFO': 'text-blue-400',
                        'SUCCESS': 'text-green-400',
                        'WARNING': 'text-yellow-400',
                        'ERROR': 'text-red-400',
                        'PHASE': 'text-purple-400',
                        'LLM': 'text-cyan-400',
                        'USER': 'text-white',
                        'AGENT': 'text-pink-400',
                        'ADMIN': 'text-yellow-500'
                    };
                    const color = levelColors[log.level] || 'text-gray-400';

                    const entry = document.createElement('div');
                    entry.className = `mb-1 ${color}`;
                    entry.innerText = `[${time}] [${log.level}] ${log.message}`;
                    logDiv.appendChild(entry);
                });

                logDiv.scrollTop = logDiv.scrollHeight;
            }
        } catch (e) {
            console.error('Fetch logs error:', e);
        }
    }

    function addSimLog(level, message) {
        const logDiv = document.getElementById('simLogStream');
        const time = new Date().toLocaleTimeString();
        const levelColors = {
            'INFO': 'text-blue-400',
            'SUCCESS': 'text-green-400',
            'ERROR': 'text-red-400'
        };
        const color = levelColors[level] || 'text-gray-400';

        const entry = document.createElement('div');
        entry.className = `mb-1 ${color}`;
        entry.innerText = `[${time}] [${level}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function loadSimHistory() {
        try {
            const res = await fetch('/api/admin/simulation/history', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            const historyDiv = document.getElementById('simHistory');
            if (!data.runs || data.runs.length === 0) {
                historyDiv.innerHTML = '<div class="text-gray-600 text-sm">≈Ω√°dn√© p≈ôedchoz√≠ simulace</div>';
                return;
            }

            historyDiv.innerHTML = '';
            data.runs.forEach(run => {
                const date = new Date(run.timestamp).toLocaleString('cs-CZ');
                const statusColor = run.status === 'success' ? 'text-green-500' : 'text-red-500';

                const entry = document.createElement('div');
                entry.className = 'flex justify-between items-center p-2 border border-gray-800 bg-black hover:bg-gray-900';
                entry.innerHTML = `
                    <div>
                        <div class="text-sm">${run.scenario_name}</div>
                        <div class="text-xs text-gray-500">${date}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-gray-400">${run.duration}s</span>
                        <span class="text-sm font-bold ${statusColor}">${run.status?.toUpperCase()}</span>
                    </div>
                `;
                historyDiv.appendChild(entry);
            });
        } catch (e) {
            console.error('Load history error:', e);
        }
    }

    function formatTime(seconds) {
        if (!seconds || seconds <= 0) return '--:--';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Initialize simulation view when switching to it
    const originalSwitchView = window.switchView;
    window.switchView = function (view) {
        originalSwitchView(view);
        if (view === 'simulation') {
            refreshSimStatus();
            loadSimHistory();
        }
    };

</script>
{% endblock %}