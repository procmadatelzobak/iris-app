<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systémové funkce a toky – Fáze 34</title>
    <link rel="stylesheet" href="/lore-web/style.css">
</head>
<body>
<header class="site-header">
    <div class="brand">HLINÍK Lore Web</div>
    <nav class="nav-links">
        <a href="/lore-web/index.html">Master Index</a>
        <a href="/lore-web/01_Lore_a_Narrativ/01_Svet_a_Identita_Firmy.html">Lore</a>
        <a href="/lore-web/02_Role_a_Sociologie/01_Profily_Roli.html">Role</a>
        <a href="/lore-web/03_Herni_Mechaniky/01_Systemy_a_Kriticka_Situace.html">Mechaniky</a>
        <a href="/lore-web/06_Aplikacni_Dokumentace/00_Aplikacni_Index.html">Aplikace</a>
        <a href="/lore-web/04_Technicka_Specifikace/01_Architektura_Systemu.html">Technika</a>
        <a href="/lore-web/05_Produkce_a_Vizual/01_Design_Manual.html">Vizuál</a>
    </nav>
</header>
<main class="content">
    <section class="card">
        <h1>Sdílené systémové funkce (Fáze 34)</h1>
        <p>Tato kapitola shrnuje backend logiku, která propojuje terminály a řídící panely. Popisy vycházejí z aktuální implementace FastAPI serveru a jedinečného GameState.</p>
    </section>

    <section class="card">
        <h2>1) Game loop a broadcast</h2>
        <ul>
            <li><strong>Jednovteřinový tik:</strong> Na startu se spustí asynchronní smyčka, která každou sekundu zpracuje ochlazování teploty, přepočet výkonu a detekci timeoutů agentů.</li>
            <li><strong>Timeout agentů:</strong> Pokud agent nepřijme/potvrdí zprávu v nastaveném okně, systém odešle chybu uživateli, zablokuje agenta a zapíše událost do logu.</li>
            <li><strong>Broadcast změn:</strong> Při změně teploty, výkonu, treasury nebo overload flagu se odešle <code>gamestate_update</code> všem websocketům (uživatel, agent, admin, root).</li>
            <li><strong>Perzistence stavu:</strong> Při startu se GameState obnovuje z <code>data/gamestate_dump.json</code>; při vypnutí se stejný soubor zapíše s aktuálními hodnotami.</li>
        </ul>
    </section>

    <section class="card">
        <h2>2) Směrování a Shift</h2>
        <ul>
            <li><strong>Globální offset:</strong> Hodnota <em>global_shift_offset</em> posouvá mapování agent ↔ uživatel. Má rozsah 0–7 (modulo 8).</li>
            <li><strong>Force Shift / Execute Shift:</strong> Admin/ROOT tlačítka zvýší offset o 1 nebo nastaví konkrétní číslo. Po změně se přepočítají všechny sockety a překreslí se graf sítí.</li>
            <li><strong>Pending responses:</strong> Routing logika sleduje, kdo má odpovědět; při přemapování se kontext resetuje, aby se předešlo cross-talku.</li>
        </ul>
    </section>

    <section class="card">
        <h2>3) Výkon, teplota a power cap</h2>
        <ul>
            <li><strong>Výpočet loadu:</strong> <em>COST_BASE</em> + počet uživatelů × <em>COST_PER_USER</em> + autopilotů × <em>COST_PER_AUTOPILOT</em>. Nízká latence a aktivní Optimizer přidávají další náklady.</li>
            <li><strong>Overload:</strong> Flag se rozsvítí, pokud load &gt; kapacita nebo teplota &gt; 350. UI terminálů pak spouští glitch efekty.</li>
            <li><strong>Režimy Agency:</strong> Normal/Low Power/Overclock upravují rychlost ochlazování. Overclock dokonce teplotu zahřívá (záporný decay).</li>
        </ul>
    </section>

    <section class="card">
        <h2>4) Ekonomika a úkoly</h2>
        <ul>
            <li><strong>Daň a pokladna:</strong> Každá platba úkolu aplikuje sazbu <em>tax_rate</em> (výchozí 20 %). Čistá výplata jde hráči, daň do Treasury.</li>
            <li><strong>Odměny podle statusu:</strong> GameState drží defaultní hodnoty pro Low/Mid/High/Party; Root může přepsat konfiguraci a uložit ji do paměti.</li>
            <li><strong>Purgatory:</strong> Aktivuje se při záporné bilanci nebo ručním locku. Odemyká se automaticky po navýšení kreditu na ≥ 0.</li>
            <li><strong>Task lifecycle:</strong> Stavový stroj Pending → Active → Completed → Paid/Rejected. Hodnocení 0–200 % určuje výplatu.</li>
        </ul>
    </section>

    <section class="card">
        <h2>5) LLM konfigurace a nástroje</h2>
        <ul>
            <li><strong>Konfigurace v GameState:</strong> Tři LLM profily – Task evaluator (OpenAI GPT-4o), Hyper/Autopilot (OpenRouter Gemini Flash) a Optimizer (OpenRouter Gemini Flash). Modely jsou měnitelné přes Root UI (autopilot/optimizer) nebo zadáním promptu.</li>
            <li><strong>Optimizer:</strong> Když je aktivní, zvyšuje výkonovou zátěž a chrání zprávy před reportem.</li>
            <li><strong>Autopilot:</strong> Drží kontext konverzace per session, odpovídá automaticky na nové zprávy uživatele a respektuje viditelnost historie.</li>
        </ul>
    </section>

    <section class="card">
        <h2>6) Lokalizace a dokumenty</h2>
        <ul>
            <li><strong>Překladový slovník:</strong> GameState má <em>language_mode</em> (cz/czech-iris) a <em>custom_labels</em>. Admin může přepsat texty tlačítek a stavů, změny se propíšou přes API do všech terminálů.</li>
            <li><strong>Dokumentový viewer:</strong> Endpoint <code>/docs/{name}</code> načítá markdown soubory a obarví je podle role (uživatel/agent/admin/root).</li>
        </ul>
    </section>

    <section class="card">
        <h2>7) Perzistence a testovací režim</h2>
        <ul>
            <li><strong>Seed dat:</strong> Při startu se inicializuje SQLite, vytvoří se výchozí uživatelé a role.</li>
            <li><strong>Test Mode toggle:</strong> Root zapíná rychlá přihlášení – na login obrazovce se zobrazí všechna tlačítka s předvyplněnými hesly.</li>
            <li><strong>Dump GameState:</strong> Při shutdownu se uloží teplota, shift, treasury, overload flag a power capacity do JSON. Po restartu se tato data načtou a pokračují v broadcastu.</li>
        </ul>
    </section>

    <section class="card">
        <h2>Další kapitoly</h2>
        <p>Viz <a href="/lore-web/06_Aplikacni_Dokumentace/01_Uzivatelske_Terminaly.html">Uživatelské terminály</a>, <a href="/lore-web/06_Aplikacni_Dokumentace/02_Agentni_Terminaly.html">Agentní terminály</a> a <a href="/lore-web/06_Aplikacni_Dokumentace/03_Admin_HUB.html">Admin HUB</a> pro front-end kontext.</p>
    </section>
</main>
</body>
</html>
